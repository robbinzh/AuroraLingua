<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>èŠ¬å…°è¯­å¯¼èˆªæŒ‡ä»¤æ¿€æ´»å™¨ (é€»è¾‘ä¿®æ­£ç‰ˆ)</title>
    <style>
        body { font-family: "Microsoft YaHei", sans-serif; line-height: 1.7; margin: 20px auto; max-width: 900px; padding: 0 20px; color: #333; background-color: #f9f9f9; }
        h1, h2, h3, h4 { color: #2c3e50; }
        h1 { text-align: center; margin-bottom: 35px; font-size: 2.2em; }
        h2 { border-bottom: 2px solid #2980b9; padding-bottom: 12px; margin-top: 45px; font-size: 1.8em; color: #2980b9; } /* Navigation color: Blue */
        h3 { margin-top: 30px; font-size: 1.5em; color: #3498db; }
        .intro-box, .instruction-card, .dialogue-card, .interactive-map-container, .vocab-summary {
            background-color: #fff; border: 1px solid #e0e0e0; border-radius: 8px; padding: 20px; margin-bottom: 30px; box-shadow: 0 4px 10px rgba(0,0,0,0.08);
        }
        .intro-box { border-left: 6px solid #2980b9; }
        .instruction-card-container { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 20px; }
        .instruction-card { text-align: center; padding: 15px; }
        .instruction-card .icon { font-size: 2.5em; color: #3498db; }
        .instruction-card p { margin: 8px 0; }
        .finnish-phrase { font-weight: bold; color: #2980b9; font-size: 1.1em; }
        .note { font-size: 0.95em; color: #555; font-style: italic; display: block; margin-top: 4px; }
        .tts-button { background: none; border: none; cursor: pointer; font-size: 1.2em; margin-left: 8px; padding: 0; display: inline-block; vertical-align: middle; color: #3498db; }
        .tts-button:hover { color: #21618c; opacity: 0.8; }
        hr { border: 0; height: 1px; background-image: linear-gradient(to right, rgba(0,0,0,0), rgba(41,128,185,0.3), rgba(0,0,0,0)); margin: 40px 0; }
        .dialogue-card .dialogue-line { margin-bottom: 12px; }
        .dialogue-card .speaker { font-weight: bold; }
        .dialogue-card .learner { color: #16a085; } /* Learner's text color */
        .interactive-map-container .map-controls { text-align: center; margin-top: 15px; }
        .interactive-map-container .map-controls button { font-size: 1.5em; width: 60px; height: 60px; margin: 5px; cursor: pointer; border: 1px solid #ccc; background-color: #f8f9f9; border-radius: 5px; position: relative;}
        .interactive-map-container .map-controls button:hover { background-color: #e9ecef; }
        .map-controls .control-label { font-size: 0.6em; color: #555; position: absolute; bottom: 2px; left: 0; right: 0; }
        .vocab-summary table { width: 100%; border-collapse: collapse; margin-top: 15px; }
        .vocab-summary th, .vocab-summary td { border: 1px solid #ddd; padding: 10px; text-align: left; }
        .vocab-summary thead { background-color: #eaf2f8; }
        #map-feedback { min-height: 1.5em; }
    </style>
</head>
<body>

    <section id="navigation-activator">
        <h1>ğŸ§­ã€å¯¼èˆªæŒ‡ä»¤æ¿€æ´»å™¨ã€‘ä»Aåˆ°Bçš„åŠ¨æ€è¯­è¨€</h1>
        <div class="intro-box">
            <p>ä½ å·²ç»å­¦ä¼šäº†æè¿°â€œå“ªé‡Œæœ‰ä»€ä¹ˆâ€ï¼Œç°åœ¨æˆ‘ä»¬æ¥æ¿€æ´»ä¸€é¡¹æ›´å…³é”®çš„æŠ€èƒ½ï¼š**å¦‚ä½•ä»ä¸€ä¸ªåœ°æ–¹å»åˆ°å¦ä¸€ä¸ªåœ°æ–¹**ã€‚</p>
            <p>è¿™ä¸ªæ¨¡å—å°†ä¸ºä½ è£…å¤‡ä¸Šæœ€æ ¸å¿ƒçš„åŠ¨æ€å¯¼èˆªæŒ‡ä»¤ï¼Œè®©ä½ ä¸ä»…èƒ½å¬æ‡‚åˆ«äººçš„æŒ‡è·¯ï¼Œè¿˜èƒ½æ¸…æ™°åœ°æè¿°è‡ªå·±çš„è¡ŒåŠ¨è·¯çº¿ã€‚</p>
        </div>

        <h2>æ­¥éª¤ä¸€ï¼šæ ¸å¿ƒå¯¼èˆªè¯­å—</h2>
        <p>é¦–å…ˆï¼Œè®©æˆ‘ä»¬è®¤è¯†è¿™äº›æŒ‡è·¯æ—¶æœ€é«˜é¢‘çš„â€œåŠ¨ä½œ+æ–¹å‘â€è¯­å—ã€‚æ¯ä¸ªè¯­å—éƒ½æœ‰â€œæŒ‡ä»¤å¼â€ï¼ˆåˆ«äººå¯¹ä½ è¯´ï¼‰å’Œâ€œé™ˆè¿°å¼â€ï¼ˆä½ è¯´ä½ è‡ªå·±çš„è¡ŒåŠ¨ï¼‰ä¸¤ç§å½¢å¼ã€‚</p>
        <div class="instruction-card-container">
            <div class="instruction-card"><div class="icon">â¬†ï¸</div><h4>å‘å‰èµ°</h4><p><strong>æŒ‡ä»¤:</strong> <span class="speakable-finnish">Mene suoraan eteenpÃ¤in!</span></p><p><strong>é™ˆè¿°:</strong> <span class="speakable-finnish">MinÃ¤ menen suoraan eteenpÃ¤in.</span></p></div>
            <div class="instruction-card"><div class="icon">â¬…ï¸</div><h4>å·¦è½¬</h4><p><strong>æŒ‡ä»¤:</strong> <span class="speakable-finnish">KÃ¤Ã¤nny vasemmalle!</span></p><p><strong>é™ˆè¿°:</strong> <span class="speakable-finnish">MinÃ¤ kÃ¤Ã¤nnyn vasemmalle.</span></p></div>
            <div class="instruction-card"><div class="icon">â¡ï¸</div><h4>å³è½¬</h4><p><strong>æŒ‡ä»¤:</strong> <span class="speakable-finnish">KÃ¤Ã¤nny oikealle!</span></p><p><strong>é™ˆè¿°:</strong> <span class="speakable-finnish">MinÃ¤ kÃ¤Ã¤nnyn oikealle.</span></p></div>
            <div class="instruction-card"><div class="icon">â¬‡ï¸</div><h4>åé€€</h4><p><strong>æŒ‡ä»¤:</strong> <span class="speakable-finnish">Mene vÃ¤hÃ¤n taaksepÃ¤in.</span></p><p><strong>é™ˆè¿°:</strong> <span class="speakable-finnish">MinÃ¤ menen taaksepÃ¤in.</span></p></div>
            <div class="instruction-card"><div class="icon">â†©ï¸</div><h4>æ‰å¤´/è½¬èº«</h4><p><strong>æŒ‡ä»¤:</strong> <span class="speakable-finnish">KÃ¤Ã¤nny takaisin!</span></p><p><strong>é™ˆè¿°:</strong> <span class="speakable-finnish">MinÃ¤ kÃ¤Ã¤nnyn takaisin.</span></p></div>
            <div class="instruction-card"><div class="icon">ğŸ‘£</div><h4>æ²¿ç€...èµ°</h4><p><strong>æŒ‡ä»¤:</strong> <span class="speakable-finnish">KÃ¤vele katua pitkin!</span></p><p><strong>é™ˆè¿°:</strong> <span class="speakable-finnish">MinÃ¤ kÃ¤velen katua pitkin.</span></p></div>
             <div class="instruction-card"><div class="icon">ğŸŒ³</div><h4>ç©¿è¿‡...</h4><p><strong>æŒ‡ä»¤:</strong> <span class="speakable-finnish">Mene puiston lÃ¤pi!</span></p><p><strong>é™ˆè¿°:</strong> <span class="speakable-finnish">MinÃ¤ menen puiston lÃ¤pi.</span></p></div>
        </div>

        <h2>æ­¥éª¤äºŒï¼šç®€è¦æŒ‡è·¯åœºæ™¯å¯¹è¯ (é¥±å’Œè¾“å…¥)</h2>
        <p>ç°åœ¨ï¼Œè®©æˆ‘ä»¬çœ‹çœ‹è¿™äº›è¯­å—åœ¨çœŸå®çš„é—®è·¯å¯¹è¯ä¸­æ˜¯å¦‚ä½•ç»„åˆä½¿ç”¨çš„ã€‚</p>
        <div class="dialogue-card">
            <h4>åœºæ™¯Aï¼šè·¯å£å·¦è½¬</h4>
            <div class="dialogue-line"><span class="speaker learner">SinÃ¤:</span> <span class="speakable-finnish">Anteeksi, missÃ¤ on posti?</span></div>
            <div class="dialogue-line"><span class="speaker">MinÃ¤:</span> <span class="speakable-finnish">Se on helppo. Mene suoraan eteenpÃ¤in risteykseen asti.</span> <span class="note">(å¾ˆç®€å•ã€‚ä¸€ç›´èµ°åˆ°åå­—è·¯å£ã€‚)</span></div>
            <div class="dialogue-line"><span class="speaker">MinÃ¤:</span> <span class="speakable-finnish">Sitten, kÃ¤Ã¤nny vasemmalle. Posti on siellÃ¤, oikealla puolella.</span> <span class="note">(ç„¶åï¼Œå‘å·¦è½¬ã€‚é‚®å±€å°±åœ¨é‚£é‡Œï¼Œåœ¨(è·¯çš„)å³è¾¹ã€‚)</span></div>
            <div class="dialogue-line"><span class="speaker learner">SinÃ¤:</span> <span class="speakable-finnish">SelvÃ¤, kiitos!</span></div>
        </div>
        <div class="dialogue-card">
            <h4>åœºæ™¯Bï¼šæ²¿è¡—èµ°ï¼Œåœ¨å¯¹é¢</h4>
            <div class="dialogue-line"><span class="speaker learner">SinÃ¤:</span> <span class="speakable-finnish">Anteeksi, etsin yhtÃ¤ kirjakauppaa.</span> <span class="note">(æ‰“æ‰°äº†ï¼Œæˆ‘æ‰¾ä¸€å®¶ä¹¦åº—ã€‚)</span></div>
            <div class="dialogue-line"><span class="speaker">MinÃ¤:</span> <span class="speakable-finnish">Aivan. KÃ¤vele vain tÃ¤tÃ¤ katua pitkin, noin 200 metriÃ¤.</span> <span class="note">(å•Šå¯¹ã€‚å°±æ²¿ç€è¿™æ¡è¡—èµ°ï¼Œå¤§æ¦‚200ç±³ã€‚)</span></div>
            <div class="dialogue-line"><span class="speaker">MinÃ¤:</span> <span class="speakable-finnish">Kirjakauppa on tien toisella puolella, ison tavaratalon vastapÃ¤Ã¤tÃ¤.</span> <span class="note">(ä¹¦åº—åœ¨è·¯çš„å¦ä¸€è¾¹ï¼Œä¸€ä¸ªå¤§ç™¾è´§å…¬å¸çš„å¯¹é¢ã€‚)</span></div>
            <div class="dialogue-line"><span class="speaker learner">SinÃ¤:</span> <span class="speakable-finnish">Okei, kiitos avusta!</span></div>
        </div>
        <div class="dialogue-card">
            <h4>åœºæ™¯Cï¼šèµ°é”™è·¯ï¼Œéœ€è¦æ‰å¤´</h4>
            <div class="dialogue-line"><span class="speaker learner">SinÃ¤:</span> <span class="speakable-finnish">Anteeksi, onko museo tÃ¤llÃ¤ suunnalla?</span> <span class="note">(è¯·é—®ï¼Œåšç‰©é¦†æ˜¯è¿™ä¸ªæ–¹å‘å—ï¼Ÿ)</span></div>
            <div class="dialogue-line"><span class="speaker">MinÃ¤:</span> <span class="speakable-finnish">Ei, museo on toisessa suunnassa. SinÃ¤ menet vÃ¤Ã¤rÃ¤Ã¤n suuntaan.</span> <span class="note">(ä¸ï¼Œåšç‰©é¦†åœ¨å¦ä¸€ä¸ªæ–¹å‘ã€‚ä½ èµ°é”™æ–¹å‘äº†ã€‚)</span></div>
            <div class="dialogue-line"><span class="speaker">MinÃ¤:</span> <span class="speakable-finnish">Sinun pitÃ¤Ã¤ kÃ¤Ã¤ntyÃ¤ takaisin.</span> <span class="note">(ä½ å¿…é¡»æ‰å¤´ã€‚)</span></div>
            <div class="dialogue-line"><span class="speaker learner">SinÃ¤:</span> <span class="speakable-finnish">Voi ei! SelvÃ¤, minÃ¤ kÃ¤Ã¤nnyn takaisin. Kiitos!</span> <span class="note">(å“¦ä¸ï¼å¥½çš„ï¼Œæˆ‘æ‰å¤´å›å»ã€‚è°¢è°¢ï¼)</span></div>
        </div>
        
        <h2>æ­¥éª¤ä¸‰ï¼šå¾®å‹åœ°å›¾å¯¼èˆªæŒ‘æˆ˜</h2>
        <p>ä½ å·²ç»çœ‹è¿‡äº†åˆ«äººå¦‚ä½•æŒ‡è·¯ï¼Œç°åœ¨è½®åˆ°ä½ äº²è‡ªæ“ä½œäº†ï¼æ ¹æ®å±å¹•ä¸Šæ–¹çš„æŒ‡ä»¤ï¼Œä½¿ç”¨ä¸‹é¢çš„æ§åˆ¶æŒ‰é’®ï¼Œå°†ä½ çš„å›¾æ ‡ ğŸ“ ç§»åŠ¨åˆ°ç»ˆç‚¹ ğŸã€‚</p>
        <div class="interactive-map-container">
            <h4 id="map-instruction-text" style="text-align:center; min-height: 2.2em;"></h4>
            <div style="text-align:center;">
                <svg id="navigation-map" width="300" height="300" style="border:2px solid #3498db; background-color: #ecf5fb;">
                    <path d="M 60 0 V 300 M 120 0 V 300 M 180 0 V 300 M 240 0 V 300" stroke="#bde0fe" stroke-width="1"/>
                    <path d="M 0 60 H 300 M 0 120 H 300 M 0 180 H 300 M 0 240 H 300" stroke="#bde0fe" stroke-width="1"/>
                    <text id="finish-flag" x="270" y="35" font-size="24">ğŸ</text>
                    <text id="player-icon" x="30" y="35" font-size="24" transform="rotate(0 30 35)">ğŸ“</text>
                </svg>
            </div>
            <div class="map-controls">
                <button onclick="handleMove('forward')" title="Mene eteenpÃ¤in">â†‘<span class="control-label">å‘å‰</span></button><br>
                <button onclick="handleMove('turn_left')" title="KÃ¤Ã¤nny vasemmalle">â†<span class="control-label">å·¦è½¬</span></button>
                <button onclick="handleMove('backward')" title="Mene taaksepÃ¤in">â†“<span class="control-label">åé€€</span></button>
                <button onclick="handleMove('turn_right')" title="KÃ¤Ã¤nny oikealle">â†’<span class="control-label">å³è½¬</span></button>
            </div>
            <div id="map-feedback" style="text-align:center; font-weight:bold; margin-top:10px;"></div>
        </div>

        <h2>æ­¥éª¤å››ï¼šè¯æ±‡è¡¨æ€»ç»“</h2>
        <div class="vocab-summary">
             <table>
                <thead><tr><th>èŠ¬å…°è¯­ (åŸå½¢/å›ºå®šçŸ­è¯­)</th><th>ä¸­æ–‡æ„æ€</th><th>å¤‡æ³¨ (åŠ¨è¯ç»™å‡ºminÃ¤/sinÃ¤å½¢å¼)</th></tr></thead>
                <tbody>
                    <tr><td><span class="speakable-finnish">suoraan eteenpÃ¤in</span></td><td>ä¸€ç›´å‘å‰</td><td>(å›ºå®šçŸ­è¯­)</td></tr>
                    <tr><td><span class="speakable-finnish">taaksepÃ¤in</span></td><td>å‘å</td><td>(æ–¹å‘å‰¯è¯)</td></tr>
                    <tr><td><span class="speakable-finnish">takaisin</span></td><td>å›å»ï¼Œå›æ¥</td><td>(å‰¯è¯)</td></tr>
                    <tr><td><span class="speakable-finnish">ympÃ¤ri</span></td><td>ç¯ç»•ï¼Œè½¬èº«</td><td>(å‰¯è¯/åç½®è¯)</td></tr>
                    <tr><td><span class="speakable-finnish">vasemmalle</span></td><td>å‘å·¦</td><td>(æ–¹å‘å‰¯è¯)</td></tr>
                    <tr><td><span class="speakable-finnish">oikealle</span></td><td>å‘å³</td><td>(æ–¹å‘å‰¯è¯)</td></tr>
                    <tr><td><span class="speakable-finnish">kÃ¤Ã¤ntyÃ¤</span></td><td>è½¬å¼¯</td><td><span class="speakable-finnish">minÃ¤ kÃ¤Ã¤nnyn, sinÃ¤ kÃ¤Ã¤nnyt</span></td></tr>
                    <tr><td><span class="speakable-finnish">kÃ¤vellÃ¤</span></td><td>èµ°è·¯</td><td><span class="speakable-finnish">minÃ¤ kÃ¤velen, sinÃ¤ kÃ¤velet</span></td></tr>
                    <tr><td><span class="speakable-finnish">pitkin</span></td><td>æ²¿ç€...</td><td>(åç½®è¯ï¼Œè·Ÿéƒ¨åˆ†æ ¼)</td></tr>
                    <tr><td><span class="speakable-finnish">lÃ¤pi</span></td><td>ç©¿è¿‡...</td><td>(åç½®è¯ï¼Œè·Ÿæ‰€æœ‰æ ¼)</td></tr>
                    <tr><td><span class="speakable-finnish">risteys</span></td><td>åå­—è·¯å£</td><td><span class="speakable-finnish">risteykseen</span> (å…¥æ ¼)</td></tr>
                    <tr><td><span class="speakable-finnish">tie</span></td><td>è·¯</td><td><span class="speakable-finnish">tien toisella puolella</span> (åœ¨è·¯çš„å¦ä¸€è¾¹)</td></tr>
                </tbody>
            </table>
        </div>
    </section>

<script>
    const finnishLang = 'fi-FI';
    let isSpeaking = false;

    function speakText(text, lang = finnishLang) {
        if (!('speechSynthesis' in window)) return;
        if (isSpeaking) { window.speechSynthesis.cancel(); setTimeout(() => startSpeaking(text, lang), 50); } 
        else { startSpeaking(text, lang); }
    }

    function startSpeaking(text, lang) {
        isSpeaking = true;
        const utterance = new SpeechSynthesisUtterance(text);
        utterance.lang = lang;
        utterance.rate = 0.9;
        utterance.pitch = 1.0;
        const voices = window.speechSynthesis.getVoices();
        let selectedVoice = voices.find(voice => voice.lang.toLowerCase() === 'fi-fi') || voices.find(voice => voice.lang.toLowerCase().startsWith('fi'));
        if (selectedVoice) utterance.voice = selectedVoice;
        utterance.onend = () => { isSpeaking = false; };
        utterance.onerror = () => { isSpeaking = false; };
        window.speechSynthesis.speak(utterance);
    }

    function addTTSButton(element, textToSpeak) {
        let cleanedText = textToSpeak.replace(/\s*\(.*?\)\s*/g, '').trim().replace(/ï¼ˆ.*?ï¼‰/g, '').trim().replace(/\[.*?\]/g, '').trim();
        if (!cleanedText) return;
        
        if (element.querySelector('.tts-button')) return;

        const button = document.createElement('button');
        button.className = 'tts-button';
        button.innerHTML = 'ğŸ”Š';
        button.title = 'æ’­æ”¾: ' + cleanedText;
        button.setAttribute('aria-label', 'æ’­æ”¾éŸ³é¢‘: ' + cleanedText);
        button.onclick = (event) => { event.preventDefault(); event.stopPropagation(); speakText(cleanedText); };
        
        element.appendChild(button);
    }

    function initializeAllTTS() {
        document.querySelectorAll('.speakable-finnish').forEach(el => {
            const textContent = el.textContent.split('(')[0].split('ï¼ˆ')[0].trim();
            if (textContent && !el.querySelector('.tts-button')) { addTTSButton(el, textContent); }
        });
        document.querySelectorAll('h1, h2, h3, h4, .intro-box p').forEach(container => {
             if (container.querySelector('.speakable-finnish')) return;
             const clone = container.cloneNode(true);
             clone.querySelectorAll('.note, .tts-button, .icon').forEach(child => child.remove());
             const textContent = clone.textContent.trim();
             if (textContent && !container.querySelector('.tts-button') && textContent.match(/[a-zA-ZÃ¤Ã¶Ã„Ã–]/)) { addTTSButton(container, textContent); }
        });
        document.querySelectorAll('.vocab-summary td').forEach(td => {
             if (!td.querySelector('.speakable-finnish') && !td.querySelector('.tts-button')) {
                 const text = td.textContent.trim();
                 if(text.match(/[a-zA-ZÃ¤Ã¶Ã„Ã–]/)){ addTTSButton(td, text); }
             }
        });
    }

    // --- NEW Interactive Map Logic ---
    const playerIcon = document.getElementById('player-icon');
    const finishIcon = document.getElementById('finish-flag');
    const instructionEl = document.getElementById('map-instruction-text');
    const feedbackEl = document.getElementById('map-feedback');
    const stepSize = 60;
    const gridBounds = { minX: 30, maxX: 270, minY: 35, maxY: 275 };

    let playerState = {
        x: 30,
        y: 35,
        facing: 'right', // 'up', 'down', 'left', 'right'
        rotation: 0
    };

    const challenge = [
        { type: 'forward', instruction: "Mene suoraan eteenpÃ¤in." },
        { type: 'turn_right', instruction: "KÃ¤Ã¤nny oikealle." },
        { type: 'forward', instruction: "Mene suoraan eteenpÃ¤in." },
        { type: 'forward', instruction: "Mene suoraan eteenpÃ¤in." },
        { type: 'turn_left', instruction: "KÃ¤Ã¤nny vasemmalle." },
        { type: 'forward', instruction: "Mene suoraan eteenpÃ¤in." }
    ];
    let challengeIndex = 0;
    
    function resetChallenge() {
        playerState = { x: 30, y: 35, facing: 'right', rotation: 0 };
        challengeIndex = 0;
        updatePlayerPosition();
        displayInstruction();
        feedbackEl.textContent = "";
    }

    function displayInstruction() {
        if (challengeIndex < challenge.length) {
            instructionEl.innerHTML = `<span class="speakable-finnish">${challengeIndex + 1}. ${challenge[challengeIndex].instruction}</span>`;
        } else {
            instructionEl.innerHTML = `<span class="speakable-finnish">Olet perillÃ¤!</span>`;
            checkWin();
        }
        initializeAllTTS();
    }

    function updatePlayerPosition() {
        playerIcon.setAttribute('x', playerState.x);
        playerIcon.setAttribute('y', playerState.y);
        playerIcon.setAttribute('transform', `rotate(${playerState.rotation} ${playerState.x} ${playerState.y})`);
    }

    function handleMove(action) {
        if (challengeIndex >= challenge.length) return; // Challenge complete

        const expectedAction = challenge[challengeIndex].type;
        if (action === expectedAction) {
            performAction(action);
            challengeIndex++;
            feedbackEl.textContent = "Oikein! (å¯¹!)";
            setTimeout(() => { if(feedbackEl.textContent === "Oikein! (å¯¹!)") feedbackEl.textContent = ""; }, 1500);
            displayInstruction();
        } else {
            feedbackEl.textContent = "VÃ¤Ã¤rÃ¤ liike! YritÃ¤ uudelleen. (åŠ¨ä½œé”™äº†ï¼å†è¯•è¯•ã€‚)";
        }
    }

    function performAction(action) {
        switch(action) {
            case 'forward':
                if (playerState.facing === 'up') playerState.y -= stepSize;
                if (playerState.facing === 'down') playerState.y += stepSize;
                if (playerState.facing === 'left') playerState.x -= stepSize;
                if (playerState.facing === 'right') playerState.x += stepSize;
                break;
            case 'backward':
                if (playerState.facing === 'up') playerState.y += stepSize;
                if (playerState.facing === 'down') playerState.y -= stepSize;
                if (playerState.facing === 'left') playerState.x += stepSize;
                if (playerState.facing === 'right') playerState.x -= stepSize;
                break;
            case 'turn_left':
                if (playerState.facing === 'up') playerState.facing = 'left';
                else if (playerState.facing === 'left') playerState.facing = 'down';
                else if (playerState.facing === 'down') playerState.facing = 'right';
                else if (playerState.facing === 'right') playerState.facing = 'up';
                playerState.rotation -= 90;
                break;
            case 'turn_right':
                if (playerState.facing === 'up') playerState.facing = 'right';
                else if (playerState.facing === 'right') playerState.facing = 'down';
                else if (playerState.facing === 'down') playerState.facing = 'left';
                else if (playerState.facing === 'left') playerState.facing = 'up';
                playerState.rotation += 90;
                break;
        }
        // Clamp position to bounds
        playerState.x = Math.max(gridBounds.minX, Math.min(playerState.x, gridBounds.maxX));
        playerState.y = Math.max(gridBounds.minY, Math.min(playerState.y, gridBounds.maxY));
        updatePlayerPosition();
    }
    
    function checkWin() {
        const finishPos = { x: parseFloat(finishIcon.getAttribute('x')), y: parseFloat(finishIcon.getAttribute('y')) };
        if (Math.abs(playerState.x - finishPos.x) < stepSize && Math.abs(playerState.y - finishPos.y) < stepSize) {
             feedbackEl.innerHTML = `<button onclick="resetChallenge()">Pelaa uudelleen (å†ç©ä¸€æ¬¡)</button>`;
        }
    }

    document.addEventListener('DOMContentLoaded', () => {
        if (window.speechSynthesis.getVoices().length === 0) {
            window.speechSynthesis.onvoiceschanged = initializeAllTTS;
        } else {
            initializeAllTTS();
        }
        setTimeout(initializeAllTTS, 300); 
        resetChallenge();
    });
</script>

</body>
</html>