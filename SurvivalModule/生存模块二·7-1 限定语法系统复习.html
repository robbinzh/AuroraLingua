<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>芬兰语入门 - 模块二复习 (TTS)</title>
    <style>
        body {
            font-family: "Microsoft YaHei", sans-serif;
            line-height: 1.6;
            margin: 20px auto;
            max-width: 900px;
            padding: 0 20px;
        }
        h1, h2, h3, h4 {
            color: #2c3e50;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            overflow-x: auto;
            display: block;
            margin-bottom: 20px;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }
        thead {
            background-color: #f4f4f4;
        }
        .tts-button {
            background: none;
            border: none;
            cursor: pointer;
            font-size: 1.2em;
            margin-left: 5px;
            padding: 0;
            display: inline-block;
            vertical-align: middle;
        }
        .tts-button:hover {
            opacity: 0.7;
        }
        .debug-section {
            background-color: #fffbf0;
            border: 2px solid #ffa500;
            padding: 15px;
            margin: 20px 0;
            border-radius: 8px;
        }
        .debug-button {
            background-color: #4CAF50;
            color: white;
            padding: 8px 16px;
            margin: 5px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        .debug-button:hover {
            background-color: #45a049;
        }
        .note {
            font-size: 0.9em;
            color: #555;
            margin-left: 10px;
        }
        .final-summary ul {
            list-style-type: none;
            padding-left: 0;
        }
        .final-summary ul li {
            margin-bottom: 5px;
        }
        .speakable-block p, .speakable-block li {
            margin-bottom: 5px;
        }
        .scene-block h3 { /* For TTS on scene titles */
            display: inline-block; /* Allows button to be next to it */
        }
    </style>
</head>
<body>

<h1>✅ 模块二限定语法系统复习</h1>

<!-- TTS调试区域 -->
<div class="debug-section">
    <h3>🔧 TTS功能测试</h3>
    <p>如果TTS按钮没有声音，请先测试以下功能：</p>
    <button class="debug-button" onclick="testBasicTTS()">测试基本TTS</button>
    <button class="debug-button" onclick="testFinnishTTS()">测试芬兰语TTS</button>
    <button class="debug-button" onclick="listVoices()">查看可用语音</button>
    <button class="debug-button" onclick="removeDebugSection()">移除调试区域</button>
    <div id="debug-output" style="margin-top: 10px; padding: 10px; background-color: #f0f0f0; border-radius: 4px; font-family: monospace; font-size: 12px; max-height: 200px; overflow-y: auto;"></div>
</div>

<hr>

<section id="grammar-system-summary">
    <h2>✅ 模块二限定语法系统</h2>
    <table>
        <thead>
            <tr>
                <th>功能</th>
                <th>动词</th>
                <th>结构 (格)</th>
                <th>示例</th>
            </tr>
        </thead>
        <tbody>
            <tr><td>意愿</td><td><span class="speakable-finnish">Haluan</span></td><td>部分格</td><td><span class="speakable-finnish">Haluan kahvia.</span></td></tr>
            <tr><td>需要</td><td><span class="speakable-finnish">Tarvitsen</span></td><td>部分格</td><td><span class="speakable-finnish">Tarvitsen kahvia.</span></td></tr>
            <tr><td>喜欢</td><td><span class="speakable-finnish">Pidän</span></td><td>出格</td><td><span class="speakable-finnish">Pidän kahvista.</span></td></tr>
            <tr><td>喝</td><td><span class="speakable-finnish">Juon</span></td><td>部分格</td><td><span class="speakable-finnish">Juon kahvia.</span></td></tr>
            <tr><td>吃</td><td><span class="speakable-finnish">Syön</span></td><td>部分格</td><td><span class="speakable-finnish">Syön leipää.</span></td></tr>
            <tr><td>否定意愿</td><td><span class="speakable-finnish">En halua</span></td><td>部分格</td><td><span class="speakable-finnish">En halua kahvia.</span></td></tr>
            <tr><td>否定需要</td><td><span class="speakable-finnish">En tarvitse</span></td><td>部分格</td><td><span class="speakable-finnish">En tarvitse apua.</span></td></tr>
            <tr><td>否定喜欢</td><td><span class="speakable-finnish">En pidä</span></td><td>出格</td><td><span class="speakable-finnish">En pidä mehusta.</span></td></tr>
            <tr><td>否定喝</td><td><span class="speakable-finnish">En juo</span></td><td>部分格</td><td><span class="speakable-finnish">En juo mehua.</span></td></tr>
            <tr><td>否定吃</td><td><span class="speakable-finnish">En syö</span></td><td>部分格</td><td><span class="speakable-finnish">En syö liian makeaa.</span></td></tr>
        </tbody>
    </table>
</section>

<hr>

<section id="scene-cafe">
    <h2>🌌 场景一：咖啡店（模块二限定语法）</h2>
    <table>
        <thead>
            <tr>
                <th>芬兰语</th>
                <th>中文翻译</th>
            </tr>
        </thead>
        <tbody>
            <tr><td><span class="speakable-finnish">Haluan kahvia, kiitos.</span></td><td>我想要点咖啡，谢谢。</td></tr>
            <tr><td><span class="speakable-finnish">Juon kahvia.</span></td><td>我喝咖啡。</td></tr>
            <tr><td><span class="speakable-finnish">Syön leipää.</span></td><td>我吃面包。</td></tr>
            <tr><td><span class="speakable-finnish">Pidän tästä kahvista.</span></td><td>我喜欢这个咖啡。</td></tr>
            <tr><td><span class="speakable-finnish">En halua mehua.</span></td><td>我不想要果汁。</td></tr>
            <tr><td><span class="speakable-finnish">En juo mehua.</span></td><td>我不喝果汁。</td></tr>
            <tr><td><span class="speakable-finnish">En pidä tästä mehusta.</span></td><td>我不喜欢这个果汁。</td></tr>
            <tr><td><span class="speakable-finnish">Tarvitsen kahvia.</span></td><td>我需要咖啡。</td></tr>
            <tr><td><span class="speakable-finnish">Missä on maito?</span></td><td>牛奶在哪？</td></tr>
            <tr><td><span class="speakable-finnish">Onko tämä hyvää kahvia?</span> <span class="note">(Tässä on hyvää kahvia? on myös ok)</span></td><td>这咖啡好吗？</td></tr>
            <tr><td><span class="speakable-finnish">En syö tätä. Onko tämä hyvää?</span></td><td>我不吃这个。这个好吃吗？</td></tr>
            <tr><td><span class="speakable-finnish">En tarvitse enää.</span></td><td>我不需要了。</td></tr>
            <tr><td><span class="speakable-finnish">Juon jotain lämmintä.</span></td><td>我喝点热的。</td></tr>
            <tr><td><span class="speakable-finnish">Syön jotain makeaa.</span></td><td>我吃点甜的。</td></tr>
            <tr><td><span class="speakable-finnish">Haluan toisen kahvin.</span></td><td>我想要另一杯咖啡。</td></tr>
            <tr><td><span class="speakable-finnish">Pidän tästä. Onko se hyvää?</span></td><td>我喜欢这个。好吃/好喝吗？</td></tr>
            <tr><td><span class="speakable-finnish">En pidä tästä. Haluan jotain toista.</span></td><td>我不喜欢这个。我想要别的。</td></tr>
        </tbody>
    </table>
</section>

<hr>

<section id="scene-restaurant">
    <h2>🧱 场景二：餐厅（模块二限定语法）</h2>
    <table>
        <thead>
            <tr>
                <th>芬兰语</th>
                <th>中文翻译</th>
            </tr>
        </thead>
        <tbody>
            <tr><td><span class="speakable-finnish">Haluan ruokaa.</span></td><td>我想要点吃的。</td></tr>
            <tr><td><span class="speakable-finnish">Syön leipää.</span></td><td>我吃面包。</td></tr>
            <tr><td><span class="speakable-finnish">En halua soppaa.</span></td><td>我不想要汤。</td></tr>
            <tr><td><span class="speakable-finnish">Mitä syöt?</span></td><td>你吃什么？</td></tr>
            <tr><td><span class="speakable-finnish">Syön kalaa.</span></td><td>我吃鱼。</td></tr>
            <tr><td><span class="speakable-finnish">Juon kahvia.</span></td><td>我喝咖啡。</td></tr>
            <tr><td><span class="speakable-finnish">Pidän tästä ruoasta.</span></td><td>我喜欢这份食物。</td></tr>
            <tr><td><span class="speakable-finnish">En pidä sopasta.</span><span class="note">(sopasta on sopan出格)</span></td><td>我不喜欢汤。</td></tr>
            <tr><td><span class="speakable-finnish">Tarvitsen vettä.</span></td><td>我需要水。</td></tr>
            <tr><td><span class="speakable-finnish">Onko tämä makeaa?</span></td><td>这甜吗？</td></tr>
            <tr><td><span class="speakable-finnish">En syö liian makeaa.</span></td><td>我不吃太甜的。</td></tr>
            <tr><td><span class="speakable-finnish">Haluan jotain lämmintä.</span></td><td>我想要点热的。</td></tr>
            <tr><td><span class="speakable-finnish">Juon jotain makeaa.</span></td><td>我喝点甜的。</td></tr>
            <tr><td><span class="speakable-finnish">Mitä juot?</span></td><td>你喝什么？</td></tr>
            <tr><td><span class="speakable-finnish">Juon kahvia.</span></td><td>我喝咖啡。</td></tr>
            <tr><td><span class="speakable-finnish">Kiitos, en tarvitse lisää.</span></td><td>谢谢，我不需要更多了。</td></tr>
            <tr><td><span class="speakable-finnish">En halua enää.</span></td><td>我不想要了。</td></tr>
            <tr><td><span class="speakable-finnish">En juo olutta.</span></td><td>我不喝啤酒。</td></tr>
        </tbody>
    </table>
</section>

<hr>

<section id="scene-post-office">
    <h2>🧬 场景三：邮局 / 柜台（模块二限定语法）</h2>
    <table>
        <thead>
            <tr>
                <th>芬兰语</th>
                <th>中文翻译</th>
            </tr>
        </thead>
        <tbody>
            <tr><td><span class="speakable-finnish">Haluan postimerkin.</span> <span class="note">(邮票 = postimerkki, lipun = 票)</span></td><td>我想要张邮票。</td></tr>
            <tr><td><span class="speakable-finnish">Tarvitsen lomaketta.</span></td><td>我需要张表格。</td></tr>
            <tr><td><span class="speakable-finnish">En halua tätä.</span></td><td>我不想要这个。</td></tr>
            <tr><td><span class="speakable-finnish">En tarvitse tätä.</span></td><td>我不需要这个。</td></tr>
            <tr><td><span class="speakable-finnish">Pidän tästä.</span></td><td>我喜欢这个。</td></tr>
            <tr><td><span class="speakable-finnish">Juon kahvia.</span></td><td>我喝咖啡。 <span class="note">(在邮局喝咖啡？也许是等待时)</span></td></tr>
            <tr><td><span class="speakable-finnish">Syön muroja.</span></td><td>我吃麦片。 <span class="note">(在邮局吃麦片？场景可能需要调整)</span></td></tr>
            <tr><td><span class="speakable-finnish">En pidä tästä.</span></td><td>我不喜欢这个。</td></tr>
            <tr><td><span class="speakable-finnish">En pidä siitä.</span></td><td>我不喜欢那个。</td></tr>
            <tr><td><span class="speakable-finnish">Onko tämä hyvää kahvia?</span></td><td>这咖啡好吗？</td></tr>
            <tr><td><span class="speakable-finnish">Tarvitsen jotain.</span></td><td>我需要点什么。</td></tr>
            <tr><td><span class="speakable-finnish">Haluan jotain.</span></td><td>我想要点什么。</td></tr>
            <tr><td><span class="speakable-finnish">En tarvitse enää.</span></td><td>我不需要了。</td></tr>
            <tr><td><span class="speakable-finnish">En halua enää.</span></td><td>我不想要了。</td></tr>
            <tr><td><span class="speakable-finnish">Minä en pidä tästä muodosta.</span> <span class="note">(muodosta on muodon出格)</span></td><td>我不喜欢这种样式。</td></tr>
        </tbody>
    </table>
</section>

<hr>

<section id="language-transformer">
    <h2>🧮 模块二·语言宇宙变形器（语块融合训练）</h2>
    <table>
        <thead>
            <tr>
                <th>模块二语块</th>
                <th>中文映射</th>
                <th>功能</th>
            </tr>
        </thead>
        <tbody>
            <tr><td><span class="speakable-finnish">Juon kahvia. Syön leipää.</span></td><td>我喝咖啡。我吃面包。</td><td>行为绑定</td></tr>
            <tr><td><span class="speakable-finnish">Haluan kahvia. Tarvitsen kahvia.</span></td><td>我想要咖啡。我需要咖啡。</td><td>意愿+现实</td></tr>
            <tr><td><span class="speakable-finnish">Pidän kahvista. En pidä mehusta.</span></td><td>我喜欢咖啡。我不喜欢果汁。</td><td>喜好反馈</td></tr>
            <tr><td><span class="speakable-finnish">En halua tätä. En syö tätä.</span></td><td>我不想要这个。我不吃这个。</td><td>双重拒绝</td></tr>
            <tr><td><span class="speakable-finnish">Juon jotain makeaa. Syön jotain lämmintä.</span></td><td>我喝点甜的。我吃点热的。</td><td>模糊表达</td></tr>
            <tr><td><span class="speakable-finnish">En tarvitse enää. En halua enää.</span></td><td>我不需要了。我不要了。</td><td>结束表达</td></tr>
        </tbody>
    </table>
</section>

<hr>

<section id="language-bleeding-task-3day" class="speakable-block">
    <h2>🧪 模块二·语言出血任务（三日计划）</h2>
    <h3><span class="speakable-finnish">📆 第1日：咖啡店植入实验</span></h3>
    <ul>
        <li><span class="speakable-finnish">坐下 → 说："Juon kahvia. Syön leipää."</span></li>
        <li><span class="speakable-finnish">被问："Mitä haluat?" → 回应："Juon kahvia. En halua mehua."</span></li>
        <li><span class="speakable-finnish">朋友问："Pidätkö?" → 回应："Pidän tästä. Onko tämä hyvää?"</span></li>
    </ul>
    <h3><span class="speakable-finnish">📆 第2日：餐厅植入实验</span></h3>
    <ul>
        <li><span class="speakable-finnish">被问："Mitä syöt?" → 回应："Syön kalaa. Juon kahvia."</span></li>
        <li><span class="speakable-finnish">服务员递上汤 → 说："En pidä sopasta. Haluan jotain makeaa."</span></li>
        <li><span class="speakable-finnish">想点甜品 → 说："Syön makeaa. En halua mehua."</span></li>
    </ul>
    <h3><span class="speakable-finnish">📆 第3日：邮局植入实验</span></h3>
    <ul>
        <li><span class="speakable-finnish">在邮局 → 指着邮票说："Haluan postimerkin."</span></li>
        <li><span class="speakable-finnish">被问："Tarvitsetko apua?" → 回应："En tarvitse apua."</span></li>
        <li><span class="speakable-finnish">被问："Pidätkö tästä?" → 回应："En pidä. Haluan jotain toista."</span></li>
        <li><span class="speakable-finnish">想要离开 → 说："En halua enää. Kiitos."</span></li>
    </ul>
</section>

<hr>

<section id="survival-chunk-summary">
    <h2>🧱 模块二·生存语块总结（高频植入清单）</h2>
    <table>
        <thead>
            <tr>
                <th>表达</th>
                <th>中文</th>
                <th>使用频率</th>
            </tr>
        </thead>
        <tbody>
            <tr><td><span class="speakable-finnish">Juon kahvia.</span></td><td>我喝咖啡。</td><td>☕☕☕☕☕</td></tr>
            <tr><td><span class="speakable-finnish">Syön leipää.</span></td><td>我吃面包。</td><td>🍞</td></tr>
            <tr><td><span class="speakable-finnish">Haluan kahvia.</span></td><td>我想要咖啡。</td><td>✅</td></tr>
            <tr><td><span class="speakable-finnish">Tarvitsen kahvia.</span></td><td>我需要咖啡。</td><td>✅</td></tr>
            <tr><td><span class="speakable-finnish">En halua mehua.</span></td><td>我不想要果汁。</td><td>✅</td></tr>
            <tr><td><span class="speakable-finnish">En juo mehua.</span></td><td>我不喝果汁。</td><td>✅</td></tr>
            <tr><td><span class="speakable-finnish">En pidä siitä.</span></td><td>我不喜欢那个。</td><td>✅</td></tr>
            <tr><td><span class="speakable-finnish">En syö liian makeaa.</span></td><td>我不吃太甜的。</td><td>✅</td></tr>
            <tr><td><span class="speakable-finnish">Juon jotain makeaa.</span></td><td>我喝点甜的。</td><td>✅</td></tr>
            <tr><td><span class="speakable-finnish">Syön jotain lämmintä.</span></td><td>我吃点热的。</td><td>✅</td></tr>
            <tr><td><span class="speakable-finnish">Haluan jotain lämmintä.</span></td><td>我想要点热的。</td><td>✅</td></tr>
            <tr><td><span class="speakable-finnish">Pidän tästä.</span></td><td>我喜欢这个。</td><td>✅</td></tr>
            <tr><td><span class="speakable-finnish">Minä en halua enää.</span></td><td>我不想要了。</td><td>✅</td></tr>
            <tr><td><span class="speakable-finnish">Minä en tarvitse enää.</span></td><td>我不需要了。</td><td>✅</td></tr>
        </tbody>
    </table>
</section>

<hr>

<section class="final-summary">
    <h3><span class="speakable-finnish">🧠 模块二认知绑定完成进度：</span></h3>
    <p>你已经构建了一个完整的【基础芬兰语生存宇宙】：</p>
    <ul>
        <li><span class="speakable-finnish">意愿表达 → Haluan</span></li>
        <li><span class="speakable-finnish">现实需求 → Tarvitsen</span></li>
        <li><span class="speakable-finnish">喜好表达 → Pidän</span></li>
        <li><span class="speakable-finnish">行为表达 → Juon / Syön</span></li>
        <li><span class="speakable-finnish">否定系统 → En halua / En tarvitse / En pidä / En juo / En syö</span></li>
    </ul>
</section>

<script>
/**
 * 调试输出函数
 * @param {string} message - 要显示的消息
 */
function debugLog(message) {
    const output = document.getElementById('debug-output');
    if (output) {
        const time = new Date().toLocaleTimeString();
        output.innerHTML += `[${time}] ${message}<br>`;
        output.scrollTop = output.scrollHeight;
    }
    console.log(message);
}

function testBasicTTS() {
    debugLog('开始测试基本TTS功能...');
    if (!('speechSynthesis' in window)) {
        debugLog('❌ 错误：浏览器不支持语音合成API');
        alert('您的浏览器不支持语音合成功能，请尝试使用Chrome、Edge或Firefox的最新版本。');
        return;
    }
    debugLog('✅ 浏览器支持语音合成API');
    const utterance = new SpeechSynthesisUtterance('Hello World');
    utterance.onstart = () => debugLog('✅ 英语测试开始播放');
    utterance.onend = () => debugLog('✅ 英语测试播放完成');
    utterance.onerror = (event) => debugLog('❌ 英语测试错误: ' + event.error);
    window.speechSynthesis.speak(utterance);
}

function testFinnishTTS() {
    debugLog('开始测试芬兰语TTS功能...');
    const utterance = new SpeechSynthesisUtterance('Haluan kahvia, kiitos.'); // Example Finnish sentence
    utterance.lang = 'fi-FI';
    utterance.onstart = () => debugLog('✅ 芬兰语测试开始播放');
    utterance.onend = () => debugLog('✅ 芬兰语测试播放完成');
    utterance.onerror = (event) => debugLog('❌ 芬兰语测试错误: ' + event.error);
    window.speechSynthesis.speak(utterance);
}

function listVoices() {
    debugLog('正在获取可用语音列表...');
    const voices = window.speechSynthesis.getVoices();
    if (voices.length === 0) {
        debugLog('⚠️ 未找到任何语音，语音可能还在加载中。请稍后再试或检查浏览器设置。');
        window.speechSynthesis.onvoiceschanged = () => {
            debugLog('语音列表已更新，重新获取...');
            const updatedVoices = window.speechSynthesis.getVoices();
            if (updatedVoices.length === 0) {
                 debugLog('⚠️ 更新后仍未找到任何语音。');
                 return;
            }
            logVoiceList(updatedVoices);
        };
        return;
    }
    logVoiceList(voices);
}

function logVoiceList(voices) {
    debugLog(`找到 ${voices.length} 个可用语音:`);
    voices.forEach((voice, index) => {
        const isDefault = voice.default ? ' (默认)' : '';
        debugLog(`${index + 1}. ${voice.name} (${voice.lang})${isDefault}`);
    });
    const finnishVoices = voices.filter(voice => 
        voice.lang.toLowerCase().startsWith('fi') || 
        voice.name.toLowerCase().includes('finnish') ||
        voice.name.toLowerCase().includes('suomi')
    );
    if (finnishVoices.length > 0) {
        debugLog(`✅ 找到 ${finnishVoices.length} 个芬兰语语音:`);
        finnishVoices.forEach(voice => {
            debugLog(`  - ${voice.name} (${voice.lang})`);
        });
    } else {
        debugLog('❌ 未找到芬兰语语音。TTS可能使用默认语言或无法播放芬兰语。');
    }
}

function removeDebugSection() {
    const debugSection = document.querySelector('.debug-section');
    if (debugSection) {
        debugSection.style.display = 'none';
        debugLog('调试区域已隐藏');
    }
}

let isSpeaking = false;

function speakText(text, lang) {
    debugLog(`尝试播放: "${text}" (语言: ${lang})`);
    if (!('speechSynthesis' in window)) {
        alert('抱歉，您的浏览器不支持语音合成。');
        debugLog('❌ 语音合成API不可用');
        return;
    }
    if (isSpeaking) {
        window.speechSynthesis.cancel();
        debugLog('⏹️ 停止之前的播放');
        setTimeout(() => startSpeaking(text, lang), 100);
    } else {
        startSpeaking(text, lang);
    }
}

function startSpeaking(text, lang) {
    isSpeaking = true;
    const utterance = new SpeechSynthesisUtterance(text);
    utterance.lang = lang;
    utterance.rate = 0.85; 
    utterance.volume = 1.0;
    utterance.pitch = 1.0;

    const voices = window.speechSynthesis.getVoices();
    let selectedVoice = null;
    if (lang.toLowerCase().startsWith('fi')) {
        selectedVoice = voices.find(voice => voice.lang.toLowerCase() === 'fi-fi') ||
                        voices.find(voice => voice.lang.toLowerCase().startsWith('fi')) ||
                        voices.find(voice => voice.name.toLowerCase().includes('finnish') || voice.name.toLowerCase().includes('suomi'));
    }
    
    if (selectedVoice) {
        utterance.voice = selectedVoice;
       // debugLog(`使用语音: ${selectedVoice.name} (${selectedVoice.lang})`);
    } else {
        debugLog(`⚠️ 未找到语言 ${lang} 的特定语音，使用系统默认语音`);
    }
    
    utterance.onstart = () => debugLog(`▶️ 开始播放: "${text}"`);
    utterance.onend = () => {
        debugLog(`✅ 播放完成: "${text}"`);
        isSpeaking = false;
    };
    utterance.onerror = (event) => {
        debugLog(`❌ 播放错误: ${event.error} (文本: "${text}")`);
        isSpeaking = false;
        if (event.error !== 'interrupted' && event.error !== 'canceled') {
            alert('语音播放出错: ' + event.error + '. 请确保您的浏览器支持并已启用芬兰语TTS。');
        }
    };
    window.speechSynthesis.speak(utterance);
}

function addTTSButton(element, textToSpeak, lang) {
    const headers = ['动词', '功能', '结构 (格)', '示例', '芬兰语', '中文翻译', '模块二语块', '中文映射', '表达', '使用频率'];
    let cleanedTextToSpeak = textToSpeak.split('(')[0].trim(); // Remove parenthetical notes for TTS

    if (!cleanedTextToSpeak || cleanedTextToSpeak === '' || headers.includes(cleanedTextToSpeak) ) {
        return; 
    }
    if (element.querySelector('.tts-button')) return; // Avoid double-adding if already handled by speakable-finnish
    
    const button = document.createElement('button');
    button.className = 'tts-button';
    button.innerHTML = '🔊'; 
    button.title = '播放: ' + cleanedTextToSpeak;
    button.setAttribute('aria-label', '播放音频: ' + cleanedTextToSpeak);
    
    button.onclick = function(event) {
        event.preventDefault(); 
        event.stopPropagation(); 
        // debugLog(`🔊 按钮被点击: "${cleanedTextToSpeak}" (语言: ${lang})`);
        speakText(cleanedTextToSpeak, lang);
        return false; 
    };
    
    // Append button carefully
    if (element.childNodes.length > 0 && (element.childNodes[0].nodeType === Node.TEXT_NODE || element.querySelector('.speakable-finnish'))) {
        let insertBeforeNode = null;
        for(let i=0; i < element.childNodes.length; i++) {
            if(element.childNodes[i].nodeType !== Node.TEXT_NODE && 
               element.childNodes[i].className !== 'note' && 
               element.childNodes[i].className !== 'tts-button' &&
               element.childNodes[i].className !== 'speakable-finnish') {
                insertBeforeNode = element.childNodes[i];
                break;
            }
        }
        if (insertBeforeNode) {
            element.insertBefore(button, insertBeforeNode);
        } else {
            const speakableSpan = element.querySelector('.speakable-finnish');
            if (speakableSpan && !speakableSpan.querySelector('.tts-button')) {
                 speakableSpan.appendChild(button);
            } else if (!speakableSpan) { // If no speakable span, append to the element itself
                 element.appendChild(button);
            }
        }
    } else {
        element.appendChild(button);
    }
}

function initializeTTSFunctionality() {
    debugLog('🚀 开始初始化TTS功能 (模块二复习)...');
    const finnishLang = 'fi-FI';

    if (window.speechSynthesis.getVoices().length === 0) {
        window.speechSynthesis.onvoiceschanged = () => {
            debugLog("voices changed, now attaching buttons (模块二复习)");
            attachAllTTSButtons(finnishLang);
        };
    } else {
        debugLog("voices already loaded, attaching buttons (模块二复习)");
        attachAllTTSButtons(finnishLang);
    }
}

function attachAllTTSButtons(finnishLang) {
    debugLog('📝 开始添加TTS按钮到各个部分 (模块二复习)...');

    // Priority 1: Elements with .speakable-finnish class
    document.querySelectorAll('.speakable-finnish').forEach(span => {
        if (!span.querySelector('.tts-button')) {
            addTTSButton(span, span.textContent, finnishLang);
        }
    });

    // Priority 2: Tables - First column of each row in specified tables
    const tableIdsForFirstColumnTTS = ['grammar-system-summary', 'scene-cafe', 'scene-restaurant', 'scene-post-office', 'language-transformer', 'survival-chunk-summary'];
    tableIdsForFirstColumnTTS.forEach(tableId => {
        const table = document.getElementById(tableId);
        if (table) {
            table.querySelectorAll('tbody tr').forEach(row => {
                const firstTd = row.cells[0];
                if (firstTd && !firstTd.querySelector('.speakable-finnish') && !firstTd.querySelector('.tts-button')) {
                    const text = firstTd.textContent.trim();
                     if (text.length > 1 && (text.match(/[äöåÄÖÅ]/) || text.includes('.') || text.includes('!'))) { // Check for Finnish chars or sentence-like structure
                        addTTSButton(firstTd, text, finnishLang);
                    }
                }
            });
        }
    });
    
    // Priority 3: .speakable-block paragraphs and list items
     const speakableBlockSelectors = ['.speakable-block p', '.speakable-block li', '.final-summary ul li'];
     speakableBlockSelectors.forEach(selector => {
        document.querySelectorAll(selector).forEach(el => {
            if (!el.querySelector('.speakable-finnish') && !el.querySelector('.tts-button')) {
                let textContent = '';
                if (el.childNodes.length === 1 && el.childNodes[0].nodeType === Node.TEXT_NODE) {
                    textContent = el.childNodes[0].textContent.trim();
                } else {
                    let tempText = '';
                    el.childNodes.forEach(node => {
                        if (node.nodeType === Node.TEXT_NODE) {
                            tempText += node.textContent;
                        } else if (node.nodeType === Node.ELEMENT_NODE && !node.classList.contains('note') && !node.classList.contains('tts-button') && !node.classList.contains('speakable-finnish')) {
                            tempText += node.textContent;
                        }
                    });
                    textContent = tempText.trim();
                }
                // Remove Chinese parts like " → 说：" or " → 回应：" before sending to TTS
                textContent = textContent.split('→')[0].trim(); 
                textContent = textContent.replace(/^-\s*/, ''); // Remove leading "- " from list items
                
                if (textContent.length > 1 && (textContent.match(/[äöåÄÖÅ]/) || textContent.includes('.') || textContent.includes('!'))) {
                     addTTSButton(el, textContent.split('(')[0].trim(), finnishLang);
                }
            }
        });
     });

    // Priority 4: Specific H3 titles within .scene-block (if any) or section H3s
    // This is more for completeness, as titles are usually not spoken, but if needed:
    document.querySelectorAll('h3').forEach(h3 => {
        // Check if it's a specific type of H3 you want to make speakable
        // For example, if they are within certain sections and contain Finnish
        const text = h3.textContent.trim();
        if (text.includes('第') && text.includes('日') && (text.match(/[äöåÄÖÅ]/) || text.split('：')[1]?.trim().length > 1) ) { // e.g., "📆 第1日：咖啡店植入实验"
             const finnishPart = text.split('：')[1] ? text.split('：')[1].trim() : text; // Try to get text after "："
             if (finnishPart.length > 1 && !h3.querySelector('.tts-button')){
                addTTSButton(h3, finnishPart, finnishLang);
             }
        } else if (h3.parentElement && h3.parentElement.classList.contains('final-summary') && !h3.querySelector('.tts-button')) {
             if (text.length > 1 && text.match(/[äöåÄÖÅ]/)) {
                 addTTSButton(h3, text, finnishLang);
             }
        }
    });

    debugLog('✅ TTS功能按钮添加完毕 (模块二复习)！');
}

document.addEventListener('DOMContentLoaded', initializeTTSFunctionality);
</script>

</body>
</html>