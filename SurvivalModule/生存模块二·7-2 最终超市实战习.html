<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>芬兰语入门 - 超市购物实战 (模块二限定) (TTS)</title>
    <style>
        body {
            font-family: "Microsoft YaHei", sans-serif;
            line-height: 1.6;
            margin: 20px auto;
            max-width: 900px;
            padding: 0 20px;
        }
        h1, h2, h3, h4 {
            color: #2c3e50; /* Dark blue-grey for headings */
        }
        table {
            width: 100%;
            border-collapse: collapse;
            overflow-x: auto; /* For responsive tables */
            display: block;
            margin-bottom: 20px;
        }
        th, td {
            border: 1px solid #ddd; /* Light grey border */
            padding: 10px; /* Increased padding */
            text-align: left;
        }
        thead {
            background-color: #f4f4f4; /* Lighter grey for table header */
        }
        .tts-button {
            background: none;
            border: none;
            cursor: pointer;
            font-size: 1.2em;
            margin-left: 5px;
            padding: 0;
            display: inline-block;
            vertical-align: middle;
        }
        .tts-button:hover {
            opacity: 0.7;
        }
        .debug-section {
            background-color: #fffbf0; /* Light yellow for debug */
            border: 2px solid #ffa500; /* Orange border */
            padding: 15px;
            margin: 20px 0;
            border-radius: 8px;
        }
        .debug-button {
            background-color: #4CAF50; /* Green */
            color: white;
            padding: 8px 16px;
            margin: 5px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        .debug-button:hover {
            background-color: #45a049; /* Darker green */
        }
        .note {
            font-size: 0.9em;
            color: #555; /* Darker grey for notes */
            margin-left: 10px;
        }
        .final-summary ul {
            list-style-type: none; /* Remove default bullets */
            padding-left: 0;
        }
        .final-summary ul li {
            margin-bottom: 8px; /* Increased spacing */
            font-weight: bold;
        }
        .speakable-block p, .speakable-block li {
            margin-bottom: 8px; /* Increased spacing */
        }
        .task-list li {
            margin-bottom: 10px; /* Spacing for task list items */
        }
        .section-intro {
            background-color: #e7f3fe; /* Light blue background for intros */
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
        }
        hr {
            border: 0;
            height: 1px;
            background-image: linear-gradient(to right, rgba(0, 0, 0, 0), rgba(44, 62, 80, 0.75), rgba(0, 0, 0, 0));
            margin: 30px 0;
        }
    </style>
</head>
<body>

<h1>🔥 模块二·终极实战场景激活 🔥</h1>

<section class="section-intro">
    <p>我们正式进入【模块二】的最终认知跃迁场景：</p>
    <h2>🛒 超市购物实战演练 (模块二限定语法版)</h2>
</section>

<hr>

<section id="language-universe-intro">
    <h3>🧠【语言宇宙】认知植入说明：</h3>
    <p>在这个场景中，你不是在“学”芬兰语，你是在<strong>用它生存</strong>。<br>
    你将用以下动词系统<strong>构建你的购物语言现实</strong>：</p>
    <ul class="final-summary">
        <li><span class="speakable-finnish">Haluan</span> = 我想要</li>
        <li><span class="speakable-finnish">Tarvitsen</span> = 我需要</li>
        <li><span class="speakable-finnish">Pidän</span> = 我喜欢</li>
        <li><span class="speakable-finnish">En halua</span> = 我不想要</li>
        <li><span class="speakable-finnish">En tarvitse</span> = 我不需要</li>
        <li><span class="speakable-finnish">En pidä</span> = 我不喜欢</li>
        <li><span class="speakable-finnish">Juon</span> = 我喝</li>
        <li><span class="speakable-finnish">Syön</span> = 我吃</li>
        <li><span class="speakable-finnish">En juo</span> = 我不喝</li>
        <li><span class="speakable-finnish">En syö</span> = 我不吃</li>
    </ul>
</section>

<hr>

<section id="phase3-simulation">
    <h2>🧪【阶段3】实战设计：虚拟超市挑战 (AI模拟器操作逻辑)</h2>
    <div class="speakable-block">
        <h4>📌 模拟器启动指令（AI店员语音激活）：</h4>
        <p><span class="speakable-finnish">Tervetuloa. Voit valita tavarat.</span> <span class="note">(欢迎来到超市。你可以选择商品。)</span></p>
    </div>
</section>

<hr>

<section id="challenge1-shopping-list">
    <h3>🧱【虚拟挑战】1：AI购物清单 → 图片选择任务</h3>
    <h4>🛒 任务说明：</h4>
    <p>AI显示一份购物清单（文字+图片），你需要选择对应的物品，并用芬兰语说出你的选择。</p>
    <h4>📝 AI购物清单示例：</h4>
    <ul class="task-list">
        <li><span class="speakable-finnish">yksi leipä</span> <span class="note">(面包)</span></li>
        <li><span class="speakable-finnish">kaksi kahvipakettia</span> <span class="note">(咖啡, pakettia = 包/袋的部分格复数)</span></li>
        <li><span class="speakable-finnish">kolme vesipulloa</span> <span class="note">(水, pulloa = 瓶的部分格复数)</span></li>
        <li><span class="speakable-finnish">vähän mehua</span> <span class="note">(一点果汁)</span></li>
    </ul>
</section>

<hr>

<section id="implant2-checkout-dialogue">
    <h3>🧪【实战植入】2：结账对话（AI店员反馈系统）</h3>
    <div class="speakable-block">
        <h4>📌 你会见到AI店员，对话开始于：</h4>
        <p><span class="speakable-finnish">Mitä haluat?</span> <span class="note">(你想要点什么？)</span></p>
    </div>
    <p>你必须用模块二动词系统回应。</p>
</section>

<hr>

<section id="ai-feedback-mechanism">
    <h3>🧬【AI店员】反馈机制（模块二语法限定认知）</h3>
    <table>
        <thead>
            <tr>
                <th>学习者说</th>
                <th>AI店员回应</th>
                <th>中文提示</th>
            </tr>
        </thead>
        <tbody>
            <tr><td><span class="speakable-finnish">Haluan kaksi leipää.</span></td><td><span class="speakable-finnish">Selvä. Kassa on 3,50€.</span> <span class="note">(Kassa = 收银台/总额)</span></td><td>正确表达：数量+部分格</td></tr>
            <tr><td><span class="speakable-finnish">Haluan leipää ja vettä.</span></td><td><span class="speakable-finnish">Hyvä valinta!</span></td><td>合理表达：部分格</td></tr>
            <tr><td><span class="speakable-finnish">Haluan vähän kahvia.</span></td><td><span class="speakable-finnish">Tässä on kahvia.</span></td><td>正确使用：模糊量 → 部分格</td></tr>
            <tr><td><span class="speakable-finnish">Tarvitsen juustoa.</span></td><td><span class="speakable-finnish">Juustoa? Tässä on hyvä valinta.</span></td><td>需要+部分格</td></tr>
            <tr><td><span class="speakable-finnish">Syön muroja. Juon kahvia.</span></td><td><span class="speakable-finnish">Ymmärrän. Onko maku hyvä?</span></td><td>行为+喜好询问</td></tr>
            <tr><td><span class="speakable-finnish">En tarvitse mehua.</span></td><td><span class="speakable-finnish">Ei mitään ongelmaa.</span></td><td>否定需要</td></tr>
            <tr><td><span class="speakable-finnish">En pidä mehusta.</span></td><td><span class="speakable-finnish">Selvä juttu.</span> <span class="note">(Tiedänne on vanhahtava)</span></td><td>否定喜好</td></tr>
            <tr><td><span class="speakable-finnish">En syö kalaa.</span></td><td><span class="speakable-finnish">Selvä. Siirrytään seuraavaan.</span></td><td>否定行为</td></tr>
        </tbody>
    </table>
</section>

<hr>

<section id="error-trigger-repair">
    <h4>❌【错误触发】AI语言修复机制</h4>
    <table>
        <thead>
            <tr>
                <th>学习者说</th>
                <th>AI店员回应</th>
                <th>中文提示弹出内容</th>
            </tr>
        </thead>
        <tbody>
            <tr><td><span class="speakable-finnish">Haluan kaksi leipä.</span></td><td><span class="speakable-finnish">Leipä? Tarkoitatko kaksi leipää?</span></td><td>“两个面包”是确定量 → 加“呀”（leipää）</td></tr>
            <tr><td><span class="speakable-finnish">Haluan mehua ja kahvi.</span></td><td><span class="speakable-finnish">Kahvia? Haluatko myös kahvia?</span> <span class="note">(kahvi -> kahvia)</span></td><td>“咖啡”应该用“呀”结尾（kahvia）</td></tr>
            <tr><td><span class="speakable-finnish">Haluan kolmea vesiä.</span></td><td><span class="speakable-finnish">Vettä? Haluatko kolme pulloa vettä?</span> <span class="note">(vesiä -> vettä)</span></td><td>“水”说 vettä (部分格单数)</td></tr>
            <tr><td><span class="speakable-finnish">Syön kala.</span></td><td><span class="speakable-finnish">Syötkö kalaa?</span></td><td>“吃鱼”要用 kalaa，不是 kala</td></tr>
            <tr><td><span class="speakable-finnish">Juon mehu.</span></td><td><span class="speakable-finnish">Mehua? Haluatko mehua?</span> <span class="note">(mehu -> mehua)</span></td><td>果汁是 mehua，不是 mehu</td></tr>
        </tbody>
    </table>
</section>

<hr>

<section id="implant3-free-dialogue" class="speakable-block">
    <h2>📦【实战植入】3：自由对话（AI店员问答系统）</h2>
    <p>你可以问：<br><span class="speakable-finnish">Paljonko tämä maksaa?</span> <span class="note">(这是多少钱？)</span></p>
    <p>AI回应：<br><span class="speakable-finnish">Tämä maksaa 2,50 euroa.</span> <span class="note">(这个是2.50欧元。)</span></p>
    <p>你可以说：<br><span class="speakable-finnish">Pidän tästä.</span> <span class="note">(我喜欢这个。)</span></p>
    <p>AI回应：<br><span class="speakable-finnish">Hyvä! Monet pitävät tästä.</span> <span class="note">(好选择！很多人都喜欢这个。Monet = 许多人)</span></p>
    <p>你可以说：<br><span class="speakable-finnish">Tarvitsen lisää maitoa.</span> <span class="note">(我需要更多牛奶。)</span></p>
    <p>AI回应：<br><span class="speakable-finnish">Tässä on maitoa.</span> <span class="note">(这里有牛奶。)</span></p>
    <p>你可以说：<br><span class="speakable-finnish">En halua tätä.</span> <span class="note">(我不要这个。)</span></p>
    <p>AI回应：<br><span class="speakable-finnish">Ymmärrän. Eikö tämä ole hyvä?</span> <span class="note">(我理解。这个不好吗？ Eikö ole = 是不是不)</span></p>
</section>

<hr>

<section id="module2-transformer">
    <h2>🧮【模块二语块变形器】：复杂表达组合训练</h2>
    <table>
        <thead>
            <tr>
                <th>组合句型</th>
                <th>中文映射</th>
                <th>功能</th>
            </tr>
        </thead>
        <tbody>
            <tr><td><span class="speakable-finnish">Haluan yhden leivän ja vähän vettä.</span></td><td>我想要一个面包和一点水。</td><td>数量+语言绑定</td></tr>
            <tr><td><span class="speakable-finnish">Juon kahvia ja syön leipää.</span></td><td>我喝咖啡，吃面包。</td><td>喝+吃 同时表达</td></tr>
            <tr><td><span class="speakable-finnish">En halua mehua. Tarvitsen kahvia.</span></td><td>我不要果汁。我需要咖啡。</td><td>语言决策</td></tr>
            <tr><td><span class="speakable-finnish">Pidän tästä mehusta. Haluan kolme pulloa mehua.</span> <span class="note">(tai kolme mehua)</span></td><td>我喜欢这果汁。我想要三瓶果汁。</td><td>喜好+意愿</td></tr>
            <tr><td><span class="speakable-finnish">En syö kalaa. Juon kahvia.</span></td><td>我不吃鱼。我喝咖啡。</td><td>吃+喝 否定表达</td></tr>
            <tr><td><span class="speakable-finnish">Paljonko tämä maksaa?</span> <span class="note">(Montako? kysyy lukumäärää)</span></td><td>这多少钱？</td><td>价格确认</td></tr>
            <tr><td><span class="speakable-finnish">Paljonko vettä?</span></td><td>多少水？<span class="note">(tai: Kuinka paljon vettä?)</span></td><td>选择时询问</td></tr>
            <tr><td><span class="speakable-finnish">Onko tämä kahvia?</span></td><td>这是咖啡吗？</td><td>语块确认</td></tr>
            <tr><td><span class="speakable-finnish">Haluan tämän. Tämä on hyvää.</span></td><td>我想要这个。这个好。</td><td>实物绑定</td></tr>
        </tbody>
    </table>
</section>

<hr>

<section id="language-bleeding-task-supermarket" class="speakable-block">
    <h2>🧪【语言出血任务】：今日植入实验（超市实战）</h2>
    <h3>🛒 语言出血三步训练法：</h3>
    <ol class="task-list">
        <li><strong><span class="speakable-finnish">第一步：选择商品时自言自语</span></strong>
            <ul>
                <li><span class="speakable-finnish">看到牛奶 → 说："Tarvitsen maitoa."</span></li>
                <li><span class="speakable-finnish">看到面包 → 说："Syön leipää."</span></li>
                <li><span class="speakable-finnish">看到咖啡 → 说："Juon kahvia."</span></li>
            </ul>
        </li>
        <li><strong><span class="speakable-finnish">第二步：结账对话（AI店员激活）</span></strong>
            <ul>
                <li><span class="speakable-finnish">店员问："Mitä haluat?"</span><br>
                <span class="speakable-finnish">你回答："Juon kahvia. Syön leipää. Haluan kolme maitoa."</span> <span class="note">(maitoa on maidon partitiivi)</span></li>
                <li><span class="speakable-finnish">店员问："Montako?"</span><br>
                <span class="speakable-finnish">你回答："Yhden." 或 "Vähän."</span></li>
            </ul>
        </li>
        <li><strong><span class="speakable-finnish">第三步：错误触发 → 自我修正</span></strong>
            <ul>
                <li><span class="speakable-finnish">说错："Haluan kaksi leipä."</span><br>
                <span class="speakable-finnish">店员纠正："Leipä? Tarkoitatko kaksi leipää?"</span><br>
                <span class="speakable-finnish">→ 你回应："Kyllä. Haluan kaksi leipää."</span></li>
            </ul>
        </li>
    </ol>
</section>

<hr>

<section id="chinese-speaker-cognition">
    <h3>🧠【中文母语者认知植入机制】注解</h3>
    <p>在中文中，我们可以说：</p>
    <ul>
        <li>我要两个面包</li>
        <li>我要一点水</li>
        <li>我要一杯咖啡</li>
    </ul>
    <p>但在芬兰语中：</p>
    <ul>
        <li><strong>“部分格是你的语言触角”</strong>：当你说“<span class="speakable-finnish">leipää</span>”时，不是“面包的格”，而是“<strong>你现在正在用语言轻轻接触这个面包</strong>”。</li>
        <li><strong>“确定数量可能需要宾格/所有格”</strong>：当你说“<span class="speakable-finnish">yhden leivän</span>”(一个面包-宾格)时，你是在“<strong>确认这个存在</strong>”，不是“吃它”，不是“喝它”，不是“喜欢它”——你是在“<strong>确定它的实体</strong>”。
        <span class="note">(Tämä on monimutkaisempaa, mutta tässä vaiheessa yksinkertaistus on ok.)</span></li>
    </ul>
    <p>这正是我们不提语法术语，而是用<strong>语言宇宙的感知方式</strong>来引导你的大脑认知。</p>
</section>

<!-- TTS调试区域的JavaScript保持不变 -->
<script>
/**
 * 调试输出函数
 * @param {string} message - 要显示的消息
 */
function debugLog(message) {
    const output = document.getElementById('debug-output');
    if (output && output.innerHTML !== undefined) { // Check if output is valid and has innerHTML
        const time = new Date().toLocaleTimeString();
        output.innerHTML += `[${time}] ${message}<br>`;
        output.scrollTop = output.scrollHeight;
    } else if (output === null) {
      // console.warn("Debug output element not found early in script. This is okay if it's defined later in HTML.");
    }
    // Always log to console
    // console.log(`[TTS DEBUG] ${message}`);
}


function testBasicTTS() {
    debugLog('开始测试基本TTS功能...');
    if (!('speechSynthesis' in window)) {
        debugLog('❌ 错误：浏览器不支持语音合成API');
        alert('您的浏览器不支持语音合成功能，请尝试使用Chrome、Edge或Firefox的最新版本。');
        return;
    }
    debugLog('✅ 浏览器支持语音合成API');
    const utterance = new SpeechSynthesisUtterance('Hello World');
    utterance.onstart = () => debugLog('✅ 英语测试开始播放');
    utterance.onend = () => debugLog('✅ 英语测试播放完成');
    utterance.onerror = (event) => debugLog('❌ 英语测试错误: ' + event.error);
    window.speechSynthesis.speak(utterance);
}

function testFinnishTTS() {
    debugLog('开始测试芬兰语TTS功能...');
    const utterance = new SpeechSynthesisUtterance('Tervetuloa. Voit valita tavarat.'); // Example from this module
    utterance.lang = 'fi-FI';
    utterance.onstart = () => debugLog('✅ 芬兰语测试开始播放');
    utterance.onend = () => debugLog('✅ 芬兰语测试播放完成');
    utterance.onerror = (event) => debugLog('❌ 芬兰语测试错误: ' + event.error);
    window.speechSynthesis.speak(utterance);
}

function listVoices() {
    debugLog('正在获取可用语音列表...');
    const voices = window.speechSynthesis.getVoices();
    if (voices.length === 0) {
        debugLog('⚠️ 未找到任何语音，语音可能还在加载中。请稍后再试或检查浏览器设置。');
        window.speechSynthesis.onvoiceschanged = () => {
            debugLog('语音列表已更新，重新获取...');
            const updatedVoices = window.speechSynthesis.getVoices();
            if (updatedVoices.length === 0) {
                 debugLog('⚠️ 更新后仍未找到任何语音。');
                 return;
            }
            logVoiceList(updatedVoices);
        };
        return;
    }
    logVoiceList(voices);
}

function logVoiceList(voices) {
    debugLog(`找到 ${voices.length} 个可用语音:`);
    voices.forEach((voice, index) => {
        const isDefault = voice.default ? ' (默认)' : '';
        debugLog(`${index + 1}. ${voice.name} (${voice.lang})${isDefault}`);
    });
    const finnishVoices = voices.filter(voice => 
        voice.lang.toLowerCase().startsWith('fi') || 
        voice.name.toLowerCase().includes('finnish') ||
        voice.name.toLowerCase().includes('suomi')
    );
    if (finnishVoices.length > 0) {
        debugLog(`✅ 找到 ${finnishVoices.length} 个芬兰语语音:`);
        finnishVoices.forEach(voice => {
            debugLog(`  - ${voice.name} (${voice.lang})`);
        });
    } else {
        debugLog('❌ 未找到芬兰语语音。TTS可能使用默认语言或无法播放芬兰语。');
    }
}

function removeDebugSection() {
    const debugSection = document.querySelector('.debug-section');
    if (debugSection) {
        debugSection.style.display = 'none';
        debugLog('调试区域已隐藏');
    }
}

let isSpeaking = false;

function speakText(text, lang) {
   // debugLog(`尝试播放: "${text}" (语言: ${lang})`);
    if (!('speechSynthesis' in window)) {
        alert('抱歉，您的浏览器不支持语音合成。');
        debugLog('❌ 语音合成API不可用');
        return;
    }
    if (isSpeaking) {
        window.speechSynthesis.cancel();
      //  debugLog('⏹️ 停止之前的播放');
        setTimeout(() => startSpeaking(text, lang), 50); // Shorter delay
    } else {
        startSpeaking(text, lang);
    }
}

function startSpeaking(text, lang) {
    isSpeaking = true;
    const utterance = new SpeechSynthesisUtterance(text);
    utterance.lang = lang;
    utterance.rate = 0.85; 
    utterance.volume = 1.0;
    utterance.pitch = 1.0;

    const voices = window.speechSynthesis.getVoices();
    let selectedVoice = null;
    if (lang.toLowerCase().startsWith('fi')) {
        selectedVoice = voices.find(voice => voice.lang.toLowerCase() === 'fi-fi') ||
                        voices.find(voice => voice.lang.toLowerCase().startsWith('fi')) ||
                        voices.find(voice => voice.name.toLowerCase().includes('finnish') || voice.name.toLowerCase().includes('suomi'));
    }
    
    if (selectedVoice) {
        utterance.voice = selectedVoice;
      //  debugLog(`使用语音: ${selectedVoice.name} (${selectedVoice.lang})`);
    } else {
        debugLog(`⚠️ 未找到语言 ${lang} 的特定语音，使用系统默认语音`);
    }
    
    // utterance.onstart = () => debugLog(`▶️ 开始播放: "${text}"`);
    utterance.onend = () => {
      //  debugLog(`✅ 播放完成: "${text}"`);
        isSpeaking = false;
    };
    utterance.onerror = (event) => {
        debugLog(`❌ 播放错误: ${event.error} (文本: "${text}")`);
        isSpeaking = false;
        if (event.error !== 'interrupted' && event.error !== 'canceled') {
            alert('语音播放出错: ' + event.error + '. 请确保您的浏览器支持并已启用芬兰语TTS。');
        }
    };
    window.speechSynthesis.speak(utterance);
}

function addTTSButton(element, textToSpeak, lang) {
    const headers = ['动词', '功能', '结构 (格)', '示例', '芬兰语', '中文翻译', '模块二语块', '中文映射', '表达', '使用频率', '学习者说', 'AI店员回应', '中文提示', '组合句型', 'AI购物清单示例：', '任务说明：', 'AI店员语音激活）：'];
    let cleanedTextToSpeak = textToSpeak;

    // Remove Chinese explanations like (面包) or (俚语，特指0.5L) for TTS
    cleanedTextToSpeak = cleanedTextToSpeak.replace(/\s*（[^）]*）\s*/g, '').trim();
    cleanedTextToSpeak = cleanedTextToSpeak.replace(/\s*\([^\)]*\)\s*/g, '').trim();


    if (!cleanedTextToSpeak || cleanedTextToSpeak === '' || headers.includes(cleanedTextToSpeak) || headers.some(h => cleanedTextToSpeak.startsWith(h))) {
        return; 
    }
    if (element.querySelector('.tts-button')) { // Check if button is already direct child
        const directChildButton = Array.from(element.childNodes).find(node => node.nodeType === 1 && node.classList.contains('tts-button'));
        if (directChildButton) return;
    }
    
    const button = document.createElement('button');
    button.className = 'tts-button';
    button.innerHTML = '🔊'; 
    button.title = '播放: ' + cleanedTextToSpeak;
    button.setAttribute('aria-label', '播放音频: ' + cleanedTextToSpeak);
    
    button.onclick = function(event) {
        event.preventDefault(); 
        event.stopPropagation(); 
      //  debugLog(`🔊 按钮被点击: "${cleanedTextToSpeak}" (语言: ${lang})`);
        speakText(cleanedTextToSpeak, lang);
        return false; 
    };
    
    // Append button logic:
    // If element is a span.speakable-finnish, append to it.
    // If element is a block (p, li, td), append at the end of its content, before any .note span.
    if (element.classList.contains('speakable-finnish')) {
        element.appendChild(button);
    } else {
        const noteSpan = element.querySelector('.note');
        if (noteSpan) {
            element.insertBefore(button, noteSpan);
        } else {
            element.appendChild(button);
        }
    }
}


function initializeTTSFunctionality() {
    debugLog('🚀 开始初始化TTS功能 (超市购物实战)...');
    const finnishLang = 'fi-FI';

    if (window.speechSynthesis.getVoices().length === 0) {
        window.speechSynthesis.onvoiceschanged = () => {
            debugLog("voices changed, now attaching buttons (超市购物实战)");
            attachAllTTSButtons(finnishLang);
        };
    } else {
        debugLog("voices already loaded, attaching buttons (超市购物实战)");
        attachAllTTSButtons(finnishLang);
    }
}

function attachAllTTSButtons(finnishLang) {
    debugLog('📝 开始添加TTS按钮到各个部分 (超市购物实战)...');

    // 1. Speakable Finnish Spans - Highest Priority
    document.querySelectorAll('span.speakable-finnish').forEach(span => {
        // Ensure text content is not just a placeholder or already handled
        const text = span.textContent.trim();
        if (text.length > 0 && !span.querySelector('.tts-button')) {
            addTTSButton(span, text, finnishLang);
        }
    });

    // 2. Table Cells (TDs) - specifically targeting Finnish content
    // Prioritize first TD in rows of specific tables if they contain sentences.
    const mainContentTables = ['ai-feedback-mechanism', 'error-trigger-repair', 'module2-transformer'];
    mainContentTables.forEach(tableId => {
        const table = document.getElementById(tableId);
        if (table) {
            table.querySelectorAll('tbody tr').forEach(row => {
                if (row.cells[0]) {
                    const firstTd = row.cells[0];
                    const speakableInTd = firstTd.querySelector('span.speakable-finnish');
                    if (!speakableInTd && !firstTd.querySelector('.tts-button')) { // If no span and no button yet
                        const text = firstTd.textContent.trim();
                        if (text.length > 1 && (text.match(/[äöåÄÖÅ]/) || text.includes('.') || text.includes('!'))) {
                           addTTSButton(firstTd, text, finnishLang);
                        }
                    }
                }
            });
        }
    });
    
    // 3. Block elements (p, li) within designated speakable blocks
    const blockSelectors = [
        '#language-universe-intro ul li', // For the list of verbs
        '#phase3-simulation .speakable-block p',
        '#challenge1-shopping-list ul li',
        '#implant2-checkout-dialogue .speakable-block p',
        '#implant3-free-dialogue .speakable-block p',
        '#language-bleeding-task-supermarket ol.task-list > li', // Top level LIs
        '#language-bleeding-task-supermarket ol.task-list ul li', // Nested LIs
        '#chinese-speaker-cognition ul li', // For the "部分格是你的语言触角" part
        '#chinese-speaker-cognition p'
    ];

    blockSelectors.forEach(selector => {
        document.querySelectorAll(selector).forEach(el => {
            const speakableInEl = el.querySelector('span.speakable-finnish');
             // Only add button to el if no speakable-finnish child, or if speakable-finnish child doesn't cover whole text
            if (!el.querySelector('.tts-button')) { // Check if el itself or a direct child span already has a button
                let textContent = '';
                // Construct text from direct child text nodes and non-button, non-note, non-speakable-span elements
                Array.from(el.childNodes).forEach(node => {
                    if (node.nodeType === Node.TEXT_NODE) {
                        textContent += node.textContent;
                    } else if (node.nodeType === Node.ELEMENT_NODE &&
                               !node.classList.contains('note') &&
                               !node.classList.contains('tts-button') &&
                               !node.classList.contains('speakable-finnish')) {
                        // This might be too greedy if there are other structural elements
                        // For simple P and LI, it's often just text and .note or .speakable-finnish
                        // If we want to speak the whole block if no specific span:
                         // textContent += node.textContent; 
                    }
                });
                textContent = textContent.trim();
                
                // If we constructed text, and it's likely Finnish, add button to 'el'
                if (textContent.length > 1 && (textContent.match(/[äöåÄÖÅ]/) || textContent.includes('.') || textContent.includes('!'))) {
                    addTTSButton(el, textContent, finnishLang);
                } else if (speakableInEl && speakableInEl.textContent.trim() !== el.textContent.replace(/<[^>]+>/g, '').trim()) {
                    // Case: speakable-finnish is present but doesn't cover all text, and we want to speak the whole block
                    // This logic might be too complex; simpler to ensure .speakable-finnish covers exactly what to speak.
                    // For now, we prioritize the .speakable-finnish span.
                }
            }
        });
    });


    debugLog('✅ TTS功能按钮添加完毕 (超市购物实战)！');
}


document.addEventListener('DOMContentLoaded', () => {
    // Ensure debug output element exists if scripts run very early
    if (!document.getElementById('debug-output')) {
        const body = document.querySelector('body');
        const debugDiv = document.createElement('div');
        debugDiv.id = 'debug-output';
        debugDiv.style.cssText = "margin-top: 10px; padding: 10px; background-color: #f0f0f0; border-radius: 4px; font-family: monospace; font-size: 12px; max-height: 200px; overflow-y: auto; display:none;"; // Initially hidden
        const firstDebugSection = document.querySelector('.debug-section');
        if (firstDebugSection) {
            firstDebugSection.appendChild(debugDiv);
        } else if (body) {
            // As a last resort, append to body if no .debug-section is found (should not happen with your HTML structure)
            // body.insertBefore(debugDiv, body.firstChild);
        }
    }

    if (window.speechSynthesis.getVoices().length === 0) {
        window.speechSynthesis.onvoiceschanged = initializeTTSFunctionality;
    } else {
        initializeTTSFunctionality();
    }
});

</script>
</body>
</html>