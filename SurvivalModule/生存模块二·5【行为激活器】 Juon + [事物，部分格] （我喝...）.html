<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>芬兰语入门 - 我喝表达系统 (模块二·5) (TTS)</title>
    <style>
        body {
            font-family: "Microsoft YaHei", sans-serif;
            line-height: 1.6;
            margin: 20px auto;
            max-width: 900px;
            padding: 0 20px;
        }
        h1, h2, h3, h4 {
            color: #2c3e50;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            overflow-x: auto;
            display: block;
            margin-bottom: 20px;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }
        thead {
            background-color: #f4f4f4;
        }
        .example { /* Default for non-specific sections if any */
            background-color: #fdfefe;
            padding: 10px;
            border-left: 4px solid #A9CCE3; /* A general light blue for examples */
            margin: 10px 0;
        }
        .tts-button {
            background: none;
            border: none;
            cursor: pointer;
            font-size: 1.2em;
            margin-left: 5px;
            padding: 0;
            display: inline-block;
            vertical-align: middle;
        }
        .tts-button:hover {
            opacity: 0.7;
        }
        .debug-section {
            background-color: #fffbf0;
            border: 2px solid #ffa500;
            padding: 15px;
            margin: 20px 0;
            border-radius: 8px;
        }
        .debug-button {
            background-color: #4CAF50;
            color: white;
            padding: 8px 16px;
            margin: 5px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        .debug-button:hover {
            background-color: #45a049;
        }
        .note {
            font-size: 0.9em;
            color: #555;
            margin-left: 10px;
        }
        .final-summary ul {
            list-style-type: none;
            padding-left: 0;
        }
        .final-summary ul li {
            margin-bottom: 5px;
            font-weight: bold;
        }
        .final-summary ul li .speakable-finnish { /* Ensure speakable-finnish in lists are normal weight */
            font-weight: normal;
        }
        /* Section-specific example box colors */
        #modular-generator .example, #practice-list .example {
             border-left-color: #8E44AD; /* Purple for Juon specific examples */
        }
        #scenario-training .example {
            border-left-color: #1ABC9C; /* Teal for scenario training */
        }
        #implantation-choice .example {
            border-left-color: #F1C40F; /* Yellow for implantation choice */
        }

    </style>
</head>
<body>

<h1>🧱 模块二·5：【行为激活器】"Juon + [事物，部分格]"（我喝...）</h1>

<!-- TTS调试区域 -->
<div class="debug-section">
    <h3>🔧 TTS功能测试</h3>
    <p>如果TTS按钮没有声音，请先测试以下功能：</p>
    <button class="debug-button" onclick="testBasicTTS()">测试基本TTS</button>
    <button class="debug-button" onclick="testFinnishTTS('Juon kahvia.')">测试芬兰语TTS (Juon kahvia)</button>
    <button class="debug-button" onclick="listVoices()">查看可用语音</button>
    <button class="debug-button" onclick="removeDebugSection()">移除调试区域</button>
    <div id="debug-output" style="margin-top: 10px; padding: 10px; background-color: #f0f0f0; border-radius: 4px; font-family: monospace; font-size: 12px; max-height: 200px; overflow-y: auto;"></div>
</div>

<hr>

<section id="cognitive-core">
    <h2>🧠 认知绑定核心：</h2>
    <p><strong>“<span class="speakable-finnish">Haluan</span>”是意愿，“<span class="speakable-finnish">Tarvitsen</span>”是必要，“<span class="speakable-finnish">Juon</span>”是现实。</strong></p>
    <p>你已经可以表达你想/需要什么， 现在你将激活一个<strong>新的语言层</strong>：你正在<strong>做它</strong>。</p>
    <table>
        <thead>
            <tr>
                <th>动词</th>
                <th>功能</th>
                <th>场景</th>
            </tr>
        </thead>
        <tbody>
            <tr><td><span class="speakable-finnish">Haluan</span></td><td>意愿 → “我要点啥。”</td><td>点单、询问</td></tr>
            <tr><td><span class="speakable-finnish">Tarvitsen</span></td><td>必要 → “我得用。”</td><td>生存、日常需求</td></tr>
            <tr><td><span class="speakable-finnish">Juon</span></td><td>行为 → “我在喝。”</td><td>真实行为描述、社交</td></tr>
            <tr><td><span class="speakable-finnish">En juo</span></td><td>否定行为 → “我不喝。”</td><td>健康/文化表达</td></tr>
        </tbody>
    </table>
</section>

<hr>

<section id="vocab-table">
    <h2>🧬 高频饮品词汇表（部分格 + 原形 + 中文）</h2>
    <table>
        <thead>
            <tr>
                <th>原形</th>
                <th>部分格</th>
                <th>中文</th>
                <th>使用示例</th>
            </tr>
        </thead>
        <tbody>
            <tr><td><span class="speakable-finnish">kahvi</span></td><td><span class="speakable-finnish">kahvia</span></td><td>咖啡</td><td><span class="speakable-finnish">Juon kahvia.</span></td></tr>
            <tr><td><span class="speakable-finnish">vesi</span></td><td><span class="speakable-finnish">vettä</span></td><td>水</td><td><span class="speakable-finnish">Juon vettä.</span></td></tr>
            <tr><td><span class="speakable-finnish">maito</span></td><td><span class="speakable-finnish">maitoa</span></td><td>牛奶</td><td><span class="speakable-finnish">Juon maitoa.</span></td></tr>
            <tr><td><span class="speakable-finnish">olut</span></td><td><span class="speakable-finnish">olutta</span></td><td>啤酒</td><td><span class="speakable-finnish">Juon olutta.</span></td></tr>
            <tr><td><span class="speakable-finnish">mehu</span></td><td><span class="speakable-finnish">mehua</span></td><td>果汁</td><td><span class="speakable-finnish">Juon mehua.</span></td></tr>
            <tr><td><span class="speakable-finnish">limsa</span></td><td><span class="speakable-finnish">limsaa</span></td><td>软饮料</td><td><span class="speakable-finnish">Juon limsaa.</span></td></tr>
            <tr><td><span class="speakable-finnish">tee</span></td><td><span class="speakable-finnish">teetä</span></td><td>茶</td><td><span class="speakable-finnish">Juon teetä.</span></td></tr>
            <tr><td><span class="speakable-finnish">virvoitusjuoma</span></td><td><span class="speakable-finnish">virvoitusjuomaa</span></td><td>苏打水/气泡水</td><td><span class="speakable-finnish">Juon virvoitusjuomaa.</span></td></tr>
            <tr><td><span class="speakable-finnish">kalsaripesä</span> <span class="note">(口语)</span></td><td><span class="speakable-finnish">kalsaripesää</span></td><td>啤酒杯（俚语，特指0.5L）</td><td><span class="speakable-finnish">Juon kalsaripesää.</span> <span class="note">(非正式场合)</span></td></tr>
        </tbody>
    </table>
</section>

<hr>

<section id="modular-generator">
    <h2>🧩 模块化语块生成器（绑定行为和现实）</h2>
    <div class="example">
        <p><span class="speakable-finnish">Juon kahvia.</span></p>
        <p><span class="speakable-finnish">Juon vettä.</span></p>
        <p><span class="speakable-finnish">Juon maitoa.</span></p>
        <p><span class="speakable-finnish">Juon tätä.</span></p>
        <p><span class="speakable-finnish">Juon jotain makeaa.</span></p>
        <p><span class="speakable-finnish">Juon jotain kylmää.</span> <span class="note">(kylmää = 凉的 (部分格))</span></p>
    </div>

    <h4>你可以搭配使用：</h4>
    <table>
        <thead>
            <tr>
                <th>行为</th>
                <th>表达</th>
                <th>中文映射</th>
            </tr>
        </thead>
        <tbody>
            <tr><td>喝咖啡</td><td><span class="speakable-finnish">Juon kahvia.</span></td><td>咖啡是日常</td></tr>
            <tr><td>喝水</td><td><span class="speakable-finnish">Juon vettä.</span></td><td>健康选择</td></tr>
            <tr><td>喝软饮</td><td><span class="speakable-finnish">Juon limsaa.</span></td><td>轻松饮料</td></tr>
            <tr><td>喝果汁</td><td><span class="speakable-finnish">Juon mehua.</span></td><td>早餐/健康</td></tr>
            <tr><td>喝点热的</td><td><span class="speakable-finnish">Juon jotain lämmintä.</span></td><td>冬季/饭馆</td></tr>
            <tr><td>喝点甜的</td><td><span class="speakable-finnish">Juon jotain makeaa.</span></td><td>甜饮需求</td></tr>
        </tbody>
    </table>
</section>

<hr>

<section id="chinese-binding">
    <h2>🧠 中文语感绑定：Juon = “我喝/饮/饮下...”</h2>
    <p>中文母语者对“<span class="speakable-finnish">juoda</span>”动词已经非常熟悉（我要喝点什么）。<br>
    “<span class="speakable-finnish">Juon</span>”是它的“现实态” —— <strong>“我现在饮下它”</strong>。</p>
    <table>
        <thead>
            <tr>
                <th>中文 → 芬兰语</th>
                <th>语言绑定</th>
            </tr>
        </thead>
        <tbody>
            <tr><td>我喝咖啡。（我饮下）</td><td><span class="speakable-finnish">Juon kahvia.</span></td></tr>
            <tr><td>我喝点水。（我饮下一点）</td><td><span class="speakable-finnish">Juon vettä.</span></td></tr>
            <tr><td>我喝果汁。（我饮下）</td><td><span class="speakable-finnish">Juon mehua.</span></td></tr>
            <tr><td>我喝牛奶。（我饮下）</td><td><span class="speakable-finnish">Juon maitoa.</span></td></tr>
            <tr><td>我喝软饮料。（我饮下）</td><td><span class="speakable-finnish">Juon limsaa.</span></td></tr>
            <tr><td>我喝点热的。（我饮下）</td><td><span class="speakable-finnish">Juon jotain lämmintä.</span></td></tr>
        </tbody>
    </table>
</section>

<hr>

<section id="scenario-training">
    <h2>🧪 场景训练套件（使用模块二全部结构）</h2>
    <div class="example">
        <h3>📍 场景 1：在咖啡店</h3>
        <p><span class="speakable-finnish">Haluan kahvia, kiitos.</span></p>
        <p><span class="speakable-finnish">Juon kahvia.</span></p>
        <p><span class="speakable-finnish">En pidä tästä kahvista.</span></p>
        <p><span class="speakable-finnish">Tarvitsen vähän aikaa.</span></p>
    </div>
    <div class="example">
        <h3>📍 场景 2：朋友问你喝什么</h3>
        <p>朋友: <span class="speakable-finnish">Mitä juot?</span></p>
        <p>你: <span class="speakable-finnish">Juon kahvia.</span></p>
        <p>你: <span class="speakable-finnish">Pidän kahvista.</span></p>
        <p>你: <span class="speakable-finnish">En halua mehua.</span></p>
    </div>
    <div class="example">
        <h3>📍 场景 3：餐厅或饭馆</h3>
        <p><span class="speakable-finnish">Juon jotain lämmintä.</span></p>
        <p><span class="speakable-finnish">Tarvitsen juomaa.</span></p>
        <p><span class="speakable-finnish">Haluan kahvia.</span></p>
        <p><span class="speakable-finnish">En tarvitse olutta.</span></p>
    </div>
    <div class="example">
        <h3>📍 场景 4：自我对话（语言植入）</h3>
        <p><span class="speakable-finnish">Juon kahvia.</span></p>
        <p><span class="speakable-finnish">Tarvitsen lisää.</span></p>
        <p><span class="speakable-finnish">Pidän tästä.</span></p>
        <p><span class="speakable-finnish">En halua lopettaa.</span></p>
    </div>
</section>

<hr>

<section id="reality-implantation-challenge">
    <h2>🧬 现实植入挑战（三日计划）</h2>
    <h3>📆 第1日：</h3>
    <ul>
        <li><span class="speakable-finnish">坐下咖啡店 → 说："Juon kahvia. Tarvitsen kahvia."</span></li>
        <li><span class="speakable-finnish">喝水时 → 说："Juon vettä. Pidän vedestä."</span></li>
        <li><span class="speakable-finnish">对服务员说："En halua mehua."</span></li>
    </ul>
    <h3>📆 第2日：</h3>
    <ul>
        <li><span class="speakable-finnish">在菜单前 → 指："Juon tätä."（指任意饮品）</span></li>
        <li><span class="speakable-finnish">被问："Mitä haluat?" → 说："En halua, kiitos. Juon kahvia."</span> <span class="note">(这里原文没有 myöhemmin, 保持原样)</span></li>
        <li><span class="speakable-finnish">被问："Miten pidät tästä?" → 说："Pidän tästä. Juon lisää."</span></li>
    </ul>
    <h3>📆 第3日：</h3>
    <ul>
        <li><span class="speakable-finnish">朋友问："Haluatko mehua?" → 说："En halua mehua. Juon kahvia."</span></li>
        <li><span class="speakable-finnish">被递上果汁 → 说："En pidä mehusta. Juon kahvia."</span> <span class="note">(这里原文没有 mieluummin, 保持原样)</span></li>
        <li><span class="speakable-finnish">在镜子前喝咖啡 → 说："Juon kahvia. Haluan lisää. Tarvitsen kahvia."</span></li>
    </ul>
</section>

<hr>

<section id="cognitive-binding-summary">
    <h2>🧠 认知绑定：模块二四大动词系统</h2>
    <p>你现在拥有：</p>
    <table>
        <thead>
            <tr>
                <th>动词</th>
                <th>功能</th>
                <th>格</th>
                <th>语言宇宙的层面</th>
            </tr>
        </thead>
        <tbody>
            <tr><td><span class="speakable-finnish">Haluan</span></td><td>意愿</td><td>部分格</td><td>“我想要”</td></tr>
            <tr><td><span class="speakable-finnish">Tarvitsen</span></td><td>必要</td><td>部分格</td><td>“我需要”</td></tr>
            <tr><td><span class="speakable-finnish">Pidän</span></td><td>喜好</td><td>出格</td><td>“我喜欢”</td></tr>
            <tr><td><span class="speakable-finnish">Juon</span></td><td>行为</td><td>部分格</td><td>“我正在” <span class="note">(应为“我正在喝”)</span></td></tr>
        </tbody>
    </table>
</section>

<hr>

<section id="practice-list">
    <h2>✅ 高频饮品语块练习清单（模块二限定）</h2>
    <div class="example">
        <p><span class="speakable-finnish">Juon kahvia.</span></p>
        <p><span class="speakable-finnish">Juon vettä.</span></p>
        <p><span class="speakable-finnish">Juon maitoa.</span></p>
        <p><span class="speakable-finnish">Juon mehua.</span></p>
        <p><span class="speakable-finnish">Juon limsaa.</span></p>
        <p><span class="speakable-finnish">Juon jotain makeaa.</span></p>
        <p><span class="speakable-finnish">Juon jotain lämmintä.</span></p>
        <p><span class="speakable-finnish">En juo olutta.</span></p>
        <p><span class="speakable-finnish">En juo mehua.</span></p>
        <p><span class="speakable-finnish">En juo liian makeaa.</span></p>
    </div>
    <p>每天选其中3句，和动作绑定练：</p>
    <ul>
        <li>对着杯子说</li>
        <li>在咖啡店说出</li>
        <li>在超市货架说出</li>
        <li>和朋友模拟对话</li>
    </ul>
</section>

<hr>

<section id="language-bleeding-task">
    <h2>🧱 语言出血任务（咖啡店今日实战）</h2>
    <p>请完成以下三项：</p>
    <ol>
        <li><span class="speakable-finnish">坐下咖啡店 → 自言自语："Juon kahvia."（用嘴唇喝的动作）</span></li>
        <li><span class="speakable-finnish">被递上果汁 → 说："En halua mehua. Juon kahvia."</span></li>
        <li><span class="speakable-finnish">朋友问："Mitä pidät tästä?" → 回应："Pidän, mutta en pidä mehusta."</span></li>
    </ol>
</section>

<hr>

<section id="cafe-expression-toolkit">
    <h2>🧪 模块二咖啡店终极表达器（模块二限定句型）</h2>
    <table>
        <thead>
            <tr>
                <th>芬兰语句子</th>
                <th>中文翻译</th>
            </tr>
        </thead>
        <tbody>
            <tr><td><span class="speakable-finnish">Haluan kahvia.</span></td><td>我想要点咖啡。</td></tr>
            <tr><td><span class="speakable-finnish">Tarvitsen kahvia.</span></td><td>我需要咖啡。</td></tr>
            <tr><td><span class="speakable-finnish">Pidän kahvista.</span></td><td>我喜欢咖啡。</td></tr>
            <tr><td><span class="speakable-finnish">Juon kahvia.</span></td><td>我喝咖啡。</td></tr>
            <tr><td><span class="speakable-finnish">En halua mehua.</span></td><td>我不想要果汁。</td></tr>
            <tr><td><span class="speakable-finnish">En tarvitse maitoa.</span></td><td>我不需要牛奶。</td></tr>
            <tr><td><span class="speakable-finnish">En pidä mehusta.</span></td><td>我不喜欢果汁。</td></tr>
            <tr><td><span class="speakable-finnish">En juo mehua.</span></td><td>我不喝果汁。</td></tr>
            <tr><td><span class="speakable-finnish">Haluan jotain lämmintä.</span></td><td>我想要点热的。</td></tr>
            <tr><td><span class="speakable-finnish">Juon jotain makeaa.</span></td><td>我喝点甜的。</td></tr>
            <tr><td><span class="speakable-finnish">Tarvitsen vettä.</span></td><td>我需要水。</td></tr>
            <tr><td><span class="speakable-finnish">En pidä siitä.</span></td><td>我不喜欢那个。</td></tr>
            <tr><td><span class="speakable-finnish">Pidän tästä.</span></td><td>我喜欢这个。</td></tr>
            <tr><td><span class="speakable-finnish">Juon kahvia, kiitos.</span></td><td>我喝咖啡，谢谢。</td></tr>
            <tr><td><span class="speakable-finnish">Missä on kahvia?</span></td><td>咖啡在哪？<span class="note">(询问是否有咖啡提供)</span></td></tr>
            <tr><td><span class="speakable-finnish">Tässä on hyvää?</span></td><td>这个好吗？<span class="note">(更口语化)</span></td></tr>
        </tbody>
    </table>
</section>

<hr>

<section class="final-summary">
    <p>你已经构建了一个完整的【咖啡店语言宇宙】，使用的是你在【模块二】中植入的：</p>
    <ul>
        <li><span class="speakable-finnish">Haluan</span> = 我想要</li>
        <li><span class="speakable-finnish">Tarvitsen</span> = 我需要</li>
        <li><span class="speakable-finnish">Pidän</span> = 我喜欢</li>
        <li><span class="speakable-finnish">Juon</span> = 我正在喝</li>
        <li><span class="speakable-finnish">En halua</span> = 我不想要</li>
        <li><span class="speakable-finnish">En tarvitse</span> = 我不需要</li>
        <li><span class="speakable-finnish">En pidä</span> = 我不喜欢</li>
        <li><span class="speakable-finnish">En juo</span> = 我不喝</li>
    </ul>
</section>
<hr>
<section id="implantation-choice" class="example">
    <h4>现在，请选择一个你最想植入的“我喝”语块：</h4>
    <p>
        <button class="debug-button" onclick="selectImplantation('Juon kahvia.')">喝咖啡 → <span class="speakable-finnish">"Juon kahvia."</span></button><br>
        <button class="debug-button" onclick="selectImplantation('Juon mehua.')">喝果汁 → <span class="speakable-finnish">"Juon mehua."</span></button><br>
        <button class="debug-button" onclick="selectImplantation('Juon jotain makeaa.')">喝点甜的 → <span class="speakable-finnish">"Juon jotain makeaa."</span></button><br>
        <button class="debug-button" onclick="selectImplantation('Juon jotain lämmintä.')">喝点热的 → <span class="speakable-finnish">"Juon jotain lämmintä."</span></button>
    </p>
    <div id="implantation-plan-juon" style="margin-top: 15px; padding: 10px; background-color: #f0e6f6; border-radius: 4px; display: none;">
        <h5>行为植入+语言出血+现实触发训练计划 (针对 <span id="selected-phrase-juon" style="font-weight:bold;"></span>):</h5>
        <ol>
            <li><strong>行为植入 (每日3次，持续3天):</strong>
                <ul>
                    <li><strong>视觉/体感触发:</strong> 每次看到/想到/拿起选定的饮品时，立即在脑海中或轻声说出对应的芬兰语语块。</li>
                    <li><strong>动作绑定:</strong> 在实际喝这种饮品或模拟喝的动作时，清晰地说出语块。</li>
                    <li><strong>情景联想:</strong> 想象自己在芬兰特定场景（咖啡馆、家、聚会）中，需要用到这个语块，并进行模拟对话。</li>
                </ul>
            </li>
            <li><strong>语言出血 (每日至少说出5次，持续3天):</strong>
                <ul>
                    <li><strong>自我对话:</strong> 对着杯子、或者在倒饮料时，大声说出语块。</li>
                    <li><strong>微社交出血:</strong> 如果有机会，尝试在与家人/朋友谈论饮品时，插入这个芬兰语语块，并简单解释。</li>
                    <li><strong>“内心独白”出血:</strong> 在喝选定饮品时，用芬兰语进行内心独白，例如："<span class="speakable-finnish">Juon kahvia. Tämä kahvi on hyvää. Haluan lisää.</span>"</li>
                </ul>
            </li>
            <li><strong>现实触发 (找到至少2个真实机会，持续1周):</strong>
                <ul>
                    <li><strong>主动创造机会:</strong> 点单时，如果菜单上有类似饮品，尝试使用这个语块。购买饮品时，也可以对自己说。</li>
                    <li><strong>被动反应:</strong> 当别人提到相关饮品，或在媒体上看到时，立即激活大脑中的芬兰语语块。</li>
                    <li><strong>环境提示:</strong> 在水杯旁或冰箱上贴上写有该语块的便签，作为视觉触发器。</li>
                </ul>
            </li>
        </ol>
        <p><strong>目标：</strong> 让这个语块成为你想到该饮品/行为时的第一语言反应！</p>
    </div>
</section>

<script>
/**
 * 调试输出函数
 * @param {string} message - 要显示的消息
 */
function debugLog(message) {
    const output = document.getElementById('debug-output');
    if (output) {
        const time = new Date().toLocaleTimeString();
        output.innerHTML += `[${time}] ${message}<br>`;
        output.scrollTop = output.scrollHeight;
    }
    console.log(message);
}

/**
 * 测试基本TTS功能
 */
function testBasicTTS() {
    debugLog('开始测试基本TTS功能...');
    if (!('speechSynthesis' in window)) {
        debugLog('❌ 错误：浏览器不支持语音合成API');
        alert('您的浏览器不支持语音合成功能，请尝试使用Chrome、Edge或Firefox的最新版本。');
        return;
    }
    debugLog('✅ 浏览器支持语音合成API');
    
    const utterance = new SpeechSynthesisUtterance('Hello World');
    utterance.onstart = () => debugLog('✅ 英语测试开始播放');
    utterance.onend = () => debugLog('✅ 英语测试播放完成');
    utterance.onerror = (event) => debugLog('❌ 英语测试错误: ' + event.error);
    
    window.speechSynthesis.speak(utterance);
}

/**
 * 测试芬兰语TTS功能
 * @param {string} textToTest - 要测试的芬兰语文本
 */
function testFinnishTTS(textToTest = 'Juon kahvia.') { // Default test text
    debugLog(`开始测试芬兰语TTS功能: "${textToTest}"`);
    if (!('speechSynthesis' in window)) {
        debugLog('❌ 错误：浏览器不支持语音合成API');
        return;
    }
    const utterance = new SpeechSynthesisUtterance(textToTest);
    utterance.lang = 'fi-FI';
    utterance.onstart = () => debugLog(`✅ 芬兰语测试 "${textToTest}" 开始播放`);
    utterance.onend = () => debugLog(`✅ 芬兰语测试 "${textToTest}" 播放完成`);
    utterance.onerror = (event) => debugLog(`❌ 芬兰语测试 "${textToTest}" 错误: ` + event.error);
    
    window.speechSynthesis.speak(utterance);
}


/**
 * 列出所有可用语音
 */
function listVoices() {
    debugLog('正在获取可用语音列表...');
    const voices = window.speechSynthesis.getVoices();
    
    if (voices.length === 0) {
        debugLog('⚠️ 未找到任何语音，语音可能还在加载中。请稍后再试或检查浏览器设置。');
        window.speechSynthesis.onvoiceschanged = () => {
            debugLog('语音列表已更新，重新获取...');
            const updatedVoices = window.speechSynthesis.getVoices();
            if (updatedVoices.length === 0) {
                 debugLog('⚠️ 更新后仍未找到任何语音。');
                 return;
            }
            logVoiceList(updatedVoices);
        };
        return;
    }
    logVoiceList(voices);
}

function logVoiceList(voices) {
    debugLog(`找到 ${voices.length} 个可用语音:`);
    voices.forEach((voice, index) => {
        const isDefault = voice.default ? ' (默认)' : '';
        debugLog(`${index + 1}. ${voice.name} (${voice.lang})${isDefault}`);
    });
    
    const finnishVoices = voices.filter(voice => 
        voice.lang.toLowerCase().startsWith('fi') || 
        voice.name.toLowerCase().includes('finnish') ||
        voice.name.toLowerCase().includes('suomi')
    );
    
    if (finnishVoices.length > 0) {
        debugLog(`✅ 找到 ${finnishVoices.length} 个芬兰语语音:`);
        finnishVoices.forEach(voice => {
            debugLog(`  - ${voice.name} (${voice.lang})`);
        });
    } else {
        debugLog('❌ 未找到芬兰语语音。TTS可能使用默认语言或无法播放芬兰语。');
    }
}


/**
 * 移除调试区域
 */
function removeDebugSection() {
    const debugSection = document.querySelector('.debug-section');
    if (debugSection) {
        debugSection.style.display = 'none';
        debugLog('调试区域已隐藏');
    }
}

let isSpeaking = false;

function speakText(text, lang) {
    debugLog(`尝试播放: "${text}" (语言: ${lang})`);
    if (!('speechSynthesis' in window)) {
        alert('抱歉，您的浏览器不支持语音合成。');
        debugLog('❌ 语音合成API不可用');
        return;
    }
    if (isSpeaking) {
        window.speechSynthesis.cancel();
        debugLog('⏹️ 停止之前的播放');
        setTimeout(() => startSpeaking(text, lang), 100);
    } else {
        startSpeaking(text, lang);
    }
}

function startSpeaking(text, lang) {
    isSpeaking = true;
    const utterance = new SpeechSynthesisUtterance(text);
    utterance.lang = lang;
    utterance.rate = 0.85; 
    utterance.volume = 1.0;
    utterance.pitch = 1.0;

    const voices = window.speechSynthesis.getVoices();
    let selectedVoice = null;
    if (lang.toLowerCase().startsWith('fi')) {
        selectedVoice = voices.find(voice => voice.lang.toLowerCase() === 'fi-fi') ||
                        voices.find(voice => voice.lang.toLowerCase().startsWith('fi')) ||
                        voices.find(voice => voice.name.toLowerCase().includes('finnish') || voice.name.toLowerCase().includes('suomi'));
    }
    
    if (selectedVoice) {
        utterance.voice = selectedVoice;
        debugLog(`使用语音: ${selectedVoice.name} (${selectedVoice.lang})`);
    } else {
        debugLog(`⚠️ 未找到语言 ${lang} 的特定语音，使用系统默认语音`);
    }
    
    utterance.onstart = () => debugLog(`▶️ 开始播放: "${text}"`);
    utterance.onend = () => {
        debugLog(`✅ 播放完成: "${text}"`);
        isSpeaking = false;
    };
    utterance.onerror = (event) => {
        debugLog(`❌ 播放错误: ${event.error} (文本: "${text}")`);
        isSpeaking = false;
        if (event.error !== 'interrupted' && event.error !== 'canceled') {
            alert('语音播放出错: ' + event.error + '. 请确保您的浏览器支持并已启用芬兰语TTS。');
        }
    };
    window.speechSynthesis.speak(utterance);
}

function addTTSButton(element, textToSpeak, lang) {
    const headers = ['动词', '功能', '场景', '格', '语言宇宙的层面', '原形', '部分格', '中文', '使用示例', '行为', '表达', '中文映射', '中文 → 芬兰语', '语言绑定', '芬兰语句子', '芬兰语'];
    const cleanedTextToSpeak = textToSpeak.split('(')[0].trim().replace(/[→"✅]/g, '').trim(); // Remove arrows, quotes, checks

    if (!cleanedTextToSpeak || cleanedTextToSpeak === '' || headers.includes(cleanedTextToSpeak) ) {
        return; 
    }
    if (element.querySelector('.tts-button')) return;
    
    const button = document.createElement('button');
    button.className = 'tts-button';
    button.innerHTML = '🔊'; 
    button.title = '播放: ' + cleanedTextToSpeak;
    button.setAttribute('aria-label', '播放音频: ' + cleanedTextToSpeak);
    
    button.onclick = function(event) {
        event.preventDefault(); 
        event.stopPropagation(); 
        debugLog(`🔊 按钮被点击: "${cleanedTextToSpeak}" (语言: ${lang})`);
        speakText(cleanedTextToSpeak, lang);
        return false; 
    };

    // Append button carefully
    if (element.matches('td, th')) { // If it's a table cell, a simple append should be fine.
        element.appendChild(button);
    } else if (element.childNodes.length > 0) {
        // Try to insert before any .note or existing .tts-button, or at the end of text content
        let inserted = false;
        for (let i = 0; i < element.childNodes.length; i++) {
            const child = element.childNodes[i];
            if (child.nodeType === Node.ELEMENT_NODE && (child.classList.contains('note') || child.classList.contains('tts-button'))) {
                element.insertBefore(button, child);
                inserted = true;
                break;
            }
        }
        if (!inserted) {
            element.appendChild(button);
        }
    } else {
        element.appendChild(button);
    }
}


function initializeTTSFunctionality() {
    debugLog('🚀 开始初始化TTS功能 (Juon Module 2.5)...');
    const finnishLang = 'fi-FI';

    if (window.speechSynthesis.getVoices().length === 0) {
        window.speechSynthesis.onvoiceschanged = () => {
            debugLog("voices changed, now attaching buttons (Juon Module 2.5)");
            attachAllTTSButtons(finnishLang);
        };
    } else {
        debugLog("voices already loaded, attaching buttons (Juon Module 2.5)");
        attachAllTTSButtons(finnishLang);
    }
}

function attachAllTTSButtons(finnishLang) {
    debugLog('📝 开始添加TTS按钮到各个部分 (Juon Module 2.5)...');

    // General .speakable-finnish class
    document.querySelectorAll('.speakable-finnish').forEach(span => {
        addTTSButton(span, span.textContent, finnishLang);
    });

    // Tables: Iterate through TDs that don't already have a .speakable-finnish or .tts-button
    // This targets the first column of most tables if it's Finnish text
    document.querySelectorAll('table tbody tr td:not(:last-child)').forEach(td => { // Avoid adding to the last column if it's "中文映射" or similar
        if (!td.querySelector('.speakable-finnish') && !td.querySelector('.tts-button')) {
            const text = td.textContent.trim();
            // Heuristic for Finnish: contains ä, ö, or common Finnish words/structures
            if (text.match(/[äöåÄÖÅ]/) || text.includes('Juon') || text.includes('Haluan') || text.includes('Tarvitsen') || text.includes('Pidän') || text.includes('kahvia') || text.includes('vettä')) {
                if (text.length > 1 && text.length < 70 && !td.closest('thead')) {
                     addTTSButton(td, text, finnishLang);
                }
            }
        }
    });
     // Specifically target "使用示例" column if it contains speakable Finnish
    document.querySelectorAll('#vocab-table table tbody tr td:nth-child(4)').forEach(td => {
        if (!td.querySelector('.speakable-finnish') && !td.querySelector('.tts-button')) {
            const text = td.textContent.trim();
            if (text.startsWith("Juon ")) { // If it starts with "Juon "
                addTTSButton(td, text, finnishLang);
            }
        }
    });


    // Specific lists and example paragraphs
    const selectors = [
        '#modular-generator .example p',
        '#scenario-training .example p',
        '#reality-implantation-challenge ul li',
        '#practice-list .example p',
        '#language-bleeding-task ol li',
        '#cafe-expression-toolkit table tbody tr td:first-child', // Finnish sentences in the final table
        '.final-summary ul li', // For the checklist
        '#implantation-choice .example p button .speakable-finnish' // For buttons in implantation choice
    ];

    selectors.forEach(selector => {
        document.querySelectorAll(selector).forEach(el => {
            if (!el.querySelector('.speakable-finnish') && !el.querySelector('.tts-button')) {
                let textContent = '';
                if (el.childNodes.length === 1 && el.childNodes[0].nodeType === Node.TEXT_NODE) {
                    textContent = el.childNodes[0].textContent.trim();
                } else {
                    let tempText = '';
                    el.childNodes.forEach(node => {
                        if (node.nodeType === Node.TEXT_NODE) {
                            tempText += node.textContent;
                        } else if (node.nodeType === Node.ELEMENT_NODE && !node.classList.contains('note') && !node.classList.contains('tts-button')) {
                             // If it's a button, get its text content excluding children like .speakable-finnish if any (though they are handled separately)
                            if(node.tagName === 'BUTTON') {
                                node.childNodes.forEach(childNode => {
                                    if(childNode.nodeType === Node.TEXT_NODE) tempText += childNode.textContent;
                                });
                            } else {
                                tempText += node.textContent;
                            }
                        }
                    });
                    textContent = tempText.trim().replace(/→.*$/, "").trim(); // Clean up arrows and trailing text
                }
                
                if (textContent.includes('Juon ') || textContent.includes('Haluan ') || textContent.includes('Tarvitsen ') || textContent.includes('Pidän ') || textContent.includes('En ') || textContent.match(/[äöåÄÖÅ]/)) {
                    if (textContent.length > 1 && textContent.length < 200){ 
                         addTTSButton(el, textContent.split('(')[0].trim(), finnishLang);
                    }
                }
            }
        });
    });
    
    debugLog('✅ TTS功能按钮添加完毕 (Juon Module 2.5)！');
}

function selectImplantation(phrase) {
    const cleanPhrase = phrase.replace(/"/g, ''); // Remove quotes for display
    document.getElementById('selected-phrase-juon').innerHTML = `<span class="speakable-finnish">"${cleanPhrase}"</span>`;
    // Ensure the new speakable span within the plan also gets a TTS button if it doesn't have one
    const newSpeakableSpan = document.getElementById('selected-phrase-juon').querySelector('.speakable-finnish');
    if (newSpeakableSpan && !newSpeakableSpan.querySelector('.tts-button')) {
        addTTSButton(newSpeakableSpan, cleanPhrase, 'fi-FI');
    }

    document.getElementById('implantation-plan-juon').style.display = 'block';
    document.getElementById('implantation-plan-juon').scrollIntoView({ behavior: 'smooth' });
    debugLog(`行为植入计划已选择: ${phrase}`);
}


document.addEventListener('DOMContentLoaded', initializeTTSFunctionality);
</script>

</body>
</html>