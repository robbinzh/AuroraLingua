<!DOCTYPE html>
<html lang="fi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ¨¡å— 4.3ï¼šç»ˆææ•´åˆ - â€œæ˜¨æ—¥æ—¥å¿—â€æ¨¡æ‹Ÿå™¨</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&family=Noto+Sans+SC:wght@400;700&display=swap');

        body {
            font-family: 'Roboto', 'Noto Sans SC', sans-serif;
            background-color: #1a1a2e;
            color: #e0e0e0;
            line-height: 1.7;
            padding: 20px;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            padding: 30px;
            background: linear-gradient(135deg, #e94560, #0f3460);
            border-radius: 15px;
            margin-bottom: 40px;
            border: 2px solid #16213e;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
        }

        .header h1 {
            margin: 0;
            font-size: 2.5em;
            color: #fff;
            text-shadow: 0 0 10px #f9a826;
        }

        .header p {
            font-size: 1.2em;
            color: #c5c6c7;
            opacity: 0.9;
        }

        .module {
            background-color: #16213e;
            border: 1px solid #0f3460;
            border-radius: 10px;
            padding: 30px;
            margin-bottom: 40px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.3);
        }

        .module h2 {
            font-size: 2em;
            color: #f9a826;
            border-bottom: 2px solid #2a3a60;
            padding-bottom: 15px;
            margin-top: 0;
            text-align: center;
        }

        .instructions {
            background-color: rgba(249, 168, 38, 0.1);
            border-left: 5px solid #f9a826;
            padding: 15px 20px;
            margin-bottom: 25px;
            border-radius: 5px;
            color: #f5f5f5;
        }
        
        .button {
            display: inline-block;
            background: linear-gradient(135deg, #f9a826, #f57c00);
            color: #16213e;
            padding: 15px 30px;
            border: none;
            border-radius: 50px;
            cursor: pointer;
            font-size: 1.1em;
            font-weight: bold;
            transition: all 0.3s ease;
            text-transform: uppercase;
            box-shadow: 0 4px 15px rgba(249, 168, 38, 0.3);
        }

        .button:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 20px rgba(249, 168, 38, 0.5);
        }

        .button:active {
            transform: translateY(-1px);
        }
        
        .tts-btn, .translation-toggle {
            background: #2a3a60;
            color: #f9a826;
            border: 1px solid #f9a826;
            border-radius: 20px;
            padding: 8px 15px;
            cursor: pointer;
            font-size: 0.9em;
            margin-left: 10px;
            transition: all 0.2s ease;
        }
        
        .tts-btn:hover, .translation-toggle:hover {
            background: #f9a826;
            color: #16213e;
        }

        .translation {
            color: #a7a9be;
            font-style: italic;
            margin-top: 10px;
            padding: 10px;
            background-color: #0f3460;
            border-radius: 5px;
            display: none;
        }
        
        .highlight {
            color: #50fa7b; /* Green */
            font-weight: bold;
            text-shadow: 0 0 5px #50fa7b;
        }

        .highlight-neg {
            color: #ff5555; /* Red */
            font-weight: bold;
            text-shadow: 0 0 5px #ff5555;
        }
        
        .highlight-space {
            color: #8be9fd; /* Cyan */
            font-weight: bold;
            text-shadow: 0 0 5px #8be9fd;
        }
        
        .highlight-reason {
            color: #ff79c6; /* Pink */
            font-weight: bold;
            text-shadow: 0 0 5px #ff79c6;
        }

        /* Stage 1 Styles */
        .alibi-container {
            text-align: center;
        }
        .statement-box {
            background-color: #0f3460;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            border: 2px dashed #2a3a60;
        }
        .statement-box h3 {
            color: #f9a826;
            margin-top: 0;
            font-size: 1.3em;
        }
        .statement-text {
            font-size: 1.5em;
            font-weight: bold;
            color: #fff;
            min-height: 50px;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        .statement-text:hover {
            background-color: rgba(249, 168, 38, 0.1);
            border-radius: 5px;
            padding: 5px;
        }
        #correct-rebuttal {
            display: none;
        }

        /* Stage 2 Styles */
        .generator-controls {
            text-align: center;
            margin-bottom: 20px;
        }
        #log-entry-display {
            background: rgba(0,0,0,0.3);
            border: 2px solid #2a3a60;
            padding: 30px;
            border-radius: 10px;
            font-size: 1.6em;
            text-align: center;
            min-height: 100px;
            line-height: 1.5;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        #log-entry-display:hover {
            background: rgba(249, 168, 38, 0.1);
            border-color: #f9a826;
        }
    </style>
</head>
<body>

<div class="container">
    <div class="header">
        <h1>æ¨¡å— 4.3: ç»ˆææ•´åˆ</h1>
        <p>â€œæ˜¨æ—¥æ—¥å¿—â€æ¨¡æ‹Ÿå™¨ (Eilisen Lokikirja -simulaattori)</p>
    </div>

    <!-- ============================================= -->
    <!--  STAGE 1: INTERNAL CONSOLIDATION              -->
    <!-- ============================================= -->
    <div class="module">
        <h2>é˜¶æ®µä¸€: å¿«é€Ÿååº”ä¸åœ¨åœºè¯æ˜æ ¸å®å™¨</h2>
        <div class="instructions">
            <strong>è®¤çŸ¥å†²å‡»ä»»åŠ¡:</strong> ä½ æ˜¯ä¾¦æ¢ã€‚ç³»ç»Ÿä¼šç»™å‡ºå«Œç–‘äººå…³äºæ˜¨å¤©çš„é™ˆè¿°ï¼ˆè‚¯å®šæˆ–å¦å®šï¼‰ã€‚ä½ çš„ä»»åŠ¡æ˜¯å…‰é€Ÿåœ¨è„‘ä¸­æ„å»ºã€ç›¸åã€‘çš„é™ˆè¿°ï¼Œç„¶åç‚¹å‡»æŒ‰é’®æ ¸å¯¹ã€‚ç›®æ ‡ï¼šå°†æ­£åä¸¤ç§è¿‡å»æ—¶æ¨¡å¼çš„åˆ‡æ¢ç„Šæ¥åˆ°ä½ çš„ç›´è§‰é‡Œï¼
        </div>

        <div class="alibi-container">
            <div class="statement-box">
                <h3>å«Œç–‘äººé™ˆè¿° (EpÃ¤illyn Lausunto)</h3>
                <p id="suspect-statement" class="statement-text" onclick="speakText(this.textContent)">...</p>
                <button class="tts-btn" onclick="speakText(document.getElementById('suspect-statement').textContent)">ğŸ”Š</button>
                <button class="translation-toggle" onclick="toggleTranslation('suspect-translation')">ä¸­æ–‡</button>
                <div id="suspect-translation" class="translation"></div>
            </div>
            
            <button class="button" onclick="checkAlibi()">æ ¸å¯¹åé©³</button>

            <div id="correct-rebuttal" class="statement-box" style="margin-top: 20px; border-color: #f9a826;">
                <h3>æ­£ç¡®åé©³ (Oikea VastavÃ¤ite)</h3>
                <p id="rebuttal-statement" class="statement-text" onclick="speakText(this.textContent)">...</p>
                <button class="tts-btn" onclick="speakText(document.getElementById('rebuttal-statement').textContent)">ğŸ”Š</button>
                <button class="translation-toggle" onclick="toggleTranslation('rebuttal-translation')">ä¸­æ–‡</button>
                <div id="rebuttal-translation" class="translation"></div>
            </div>

            <button class="button" onclick="generateNewAlibi()" style="margin-top: 20px; background: linear-gradient(135deg, #50fa7b, #28a745); color: #16213e;">ä¸‹ä¸€åå«Œç–‘äºº (Seuraava epÃ¤ilty)</button>
        </div>
    </div>

    <!-- ============================================= -->
    <!--  STAGE 2: CROSS-MODULE INTEGRATION            -->
    <!-- ============================================= -->
    <div class="module">
        <h2>é˜¶æ®µäºŒ: æ˜¨æ—¥æ—¥å¿—åŠ¨æ€å†…å®¹ç”Ÿæˆå™¨</h2>
        <div class="instructions">
            <strong>ç»ˆæå‹åŠ›æµ‹è¯•:</strong> è¿™é‡Œæ˜¯ä¿¡æ¯çš„æ´ªæµã€‚ç³»ç»Ÿå°†ç”ŸæˆåŒ…å«ã€æ—¶é—´ã€‘ã€ã€ç©ºé—´ã€‘ã€ã€éœ€æ±‚ã€‘ç­‰å¤šä¸ªç»´åº¦çš„å¤æ‚æ—¥å¿—ã€‚ä½ çš„å”¯ä¸€ä»»åŠ¡æ˜¯ï¼šçœ‹æ‡‚ã€å¬æ‡‚ã€‚å°†ä½ çš„å¤§è„‘æš´éœ²åœ¨é«˜ä¿¡æ¯å¯†åº¦çš„èŠ¬å…°è¯­ç¯å¢ƒä¸­ï¼Œè®©å®ƒè‡ªå·±å­¦ä¼šæ¸¸æ³³ï¼
        </div>

        <div class="generator-controls">
            <button class="button" onclick="generateLogEntry()">ç”Ÿæˆæ–°çš„æ—¥å¿—æ¡ç›®</button>
        </div>

        <div id="log-entry-display" onclick="speakText(this.innerText)">
            ç‚¹å‡»æŒ‰é’®ï¼Œå¼€å§‹æ¥æ”¶ä¿¡æ¯æµ...
        </div>
        <div style="text-align: center; margin-top: 15px;">
            <button class="tts-btn" onclick="speakText(document.getElementById('log-entry-display').innerText)">ğŸ”Š</button>
            <button class="translation-toggle" onclick="toggleTranslation('log-translation')">ä¸­æ–‡</button>
        </div>
        <div id="log-translation" class="translation" style="text-align: center;"></div>
    </div>

</div>

<script>
// =============================================
//  DATA LAYER
// =============================================

const subjects = [
    { fi: "MinÃ¤", fi_pers: "minÃ¤", zh: "æˆ‘" },
    { fi: "SinÃ¤", fi_pers: "sinÃ¤", zh: "ä½ " },
    { fi: "HÃ¤n", fi_pers: "hÃ¤n", zh: "ä»–/å¥¹" },
    { fi: "Pekka", fi_pers: "hÃ¤n", zh: "ä½©å¡" },
    { fi: "Liisa", fi_pers: "hÃ¤n", zh: "ä¸½è¨" },
    { fi: "Mikko", fi_pers: "hÃ¤n", zh: "ç±³ç§‘" },
    { fi: "Anna", fi_pers: "hÃ¤n", zh: "å®‰å¨œ" },
    { fi: "Jukka", fi_pers: "hÃ¤n", zh: "å°¤å¡" },
    { fi: "Me", fi_pers: "me", zh: "æˆ‘ä»¬" },
    { fi: "Te", fi_pers: "te", zh: "ä½ ä»¬" },
    { fi: "He", fi_pers: "he", zh: "ä»–ä»¬" },
    { fi: "Minun ystÃ¤vÃ¤ni", fi_pers: "hÃ¤n", zh: "æˆ‘çš„æœ‹å‹" },
    { fi: "Minun Ã¤itini", fi_pers: "hÃ¤n", zh: "æˆ‘çš„å¦ˆå¦ˆ" },
    { fi: "Minun isÃ¤ni", fi_pers: "hÃ¤n", zh: "æˆ‘çš„çˆ¸çˆ¸" },
    { fi: "Minun veljeni", fi_pers: "hÃ¤n", zh: "æˆ‘çš„å…„å¼Ÿ" },
    { fi: "Minun siskoni", fi_pers: "hÃ¤n", zh: "æˆ‘çš„å§å¦¹" },
    { fi: "Opettaja", fi_pers: "hÃ¤n", zh: "è€å¸ˆ" },
    { fi: "LÃ¤Ã¤kÃ¤ri", fi_pers: "hÃ¤n", zh: "åŒ»ç”Ÿ" },
    { fi: "MyyjÃ¤", fi_pers: "hÃ¤n", zh: "å”®è´§å‘˜" },
    { fi: "Opiskelija", fi_pers: "hÃ¤n", zh: "å­¦ç”Ÿ" },
    { fi: "Naapuri", fi_pers: "hÃ¤n", zh: "é‚»å±…" },
    { fi: "Kollega", fi_pers: "hÃ¤n", zh: "åŒäº‹" }
];

const verbs = [
    // æ¨¡å—2åŸºç¡€åŠ¨è¯æ‰©å±•
    { root: "haluta", type: "want", imperf: { hÃ¤n: "halusi" }, neg_part: "halunnut", zh: "æƒ³è¦" },
    { root: "tarvita", type: "need", imperf: { hÃ¤n: "tarvitsi" }, neg_part: "tarvinnut", zh: "éœ€è¦" },
    { root: "pitÃ¤Ã¤", type: "like", imperf: { hÃ¤n: "piti" }, neg_part: "pitÃ¤nyt", zh: "å–œæ¬¢" },
    { root: "syÃ¶dÃ¤", type: "eat", imperf: { hÃ¤n: "sÃ¶i" }, neg_part: "syÃ¶nyt", zh: "åƒ" },
    { root: "juoda", type: "drink", imperf: { hÃ¤n: "joi" }, neg_part: "juonut", zh: "å–" },
    { root: "ostaa", type: "buy", imperf: { hÃ¤n: "osti" }, neg_part: "ostanut", zh: "ä¹°" },
    
    // æ¨¡å—4æ ¸å¿ƒåŠ¨è¯
    { root: "lukea", type: "read", imperf: { hÃ¤n: "luki" }, neg_part: "lukenut", zh: "è¯»" },
    { root: "kirjoittaa", type: "write", imperf: { hÃ¤n: "kirjoitti" }, neg_part: "kirjoittanut", zh: "å†™" },
    { root: "piirtÃ¤Ã¤", type: "draw", imperf: { hÃ¤n: "piirsi" }, neg_part: "piirtÃ¤nyt", zh: "ç”»ç”»" },
    { root: "korjata", type: "fix", imperf: { hÃ¤n: "korjasi" }, neg_part: "korjannut", zh: "ä¿®ç†" },
    { root: "siivota", type: "clean", imperf: { hÃ¤n: "siivosi" }, neg_part: "siivonut", zh: "æ‰“æ‰«" },
    { root: "sulkea", type: "close", imperf: { hÃ¤n: "sulki" }, neg_part: "sulkenut", zh: "å…³é—­" },
    { root: "keittÃ¤Ã¤", type: "cook", imperf: { hÃ¤n: "keitti" }, neg_part: "keittÃ¤nyt", zh: "ç…®" },
    
    // æ¨¡å—3ç©ºé—´åŠ¨è¯
    { root: "mennÃ¤", type: "go", imperf: { hÃ¤n: "meni" }, neg_part: "mennyt", zh: "å»" },
    { root: "tulla", type: "come", imperf: { hÃ¤n: "tuli" }, neg_part: "tullut", zh: "æ¥" },
    { root: "lÃ¤hteÃ¤", type: "leave", imperf: { hÃ¤n: "lÃ¤hti" }, neg_part: "lÃ¤htenyt", zh: "ç¦»å¼€" },
    { root: "ajaa", type: "drive", imperf: { hÃ¤n: "aja" }, neg_part: "ajanut", zh: "å¼€è½¦" },
    { root: "kÃ¤vellÃ¤", type: "walk", imperf: { hÃ¤n: "kÃ¤veli" }, neg_part: "kÃ¤vellyt", zh: "èµ°è·¯" },
    { root: "juosta", type: "run", imperf: { hÃ¤n: "juoksi" }, neg_part: "juossut", zh: "è·‘æ­¥" },
    { root: "matkustaa", type: "travel", imperf: { hÃ¤n: "matkusti" }, neg_part: "matkustanut", zh: "æ—…è¡Œ" },
    
    // æ‰©å±•åŠ¨è¯
    { root: "nÃ¤hdÃ¤", type: "see", imperf: { hÃ¤n: "nÃ¤ki" }, neg_part: "nÃ¤hnyt", zh: "çœ‹è§" },
    { root: "kuulla", type: "hear", imperf: { hÃ¤n: "kuuli" }, neg_part: "kuullut", zh: "å¬è§" },
    { root: "puhua", type: "speak", imperf: { hÃ¤n: "puhui" }, neg_part: "puhunut", zh: "è¯´è¯" },
    { root: "opiskella", type: "study", imperf: { hÃ¤n: "opiskeli" }, neg_part: "opiskellut", zh: "å­¦ä¹ " },
    { root: "tyÃ¶skennellÃ¤", type: "work", imperf: { hÃ¤n: "tyÃ¶skenteli" }, neg_part: "tyÃ¶skennellyt", zh: "å·¥ä½œ" },
    { root: "auttaa", type: "help", imperf: { hÃ¤n: "auttoi" }, neg_part: "auttanut", zh: "å¸®åŠ©" },
    { root: "tehdÃ¤", type: "do", imperf: { hÃ¤n: "teki" }, neg_part: "tehnyt", zh: "åš" },
    { root: "etsiÃ¤", type: "search", imperf: { hÃ¤n: "etsi" }, neg_part: "etsinyt", zh: "å¯»æ‰¾" },
    { root: "unohtaa", type: "forget", imperf: { hÃ¤n: "unohti" }, neg_part: "unohtanut", zh: "å¿˜è®°" },
    { root: "lÃ¶ytÃ¤Ã¤", type: "find", imperf: { hÃ¤n: "lÃ¶ysi" }, neg_part: "lÃ¶ytÃ¤nyt", zh: "æ‰¾åˆ°" },
    { root: "maksaa", type: "pay", imperf: { hÃ¤n: "maksoi" }, neg_part: "maksanut", zh: "ä»˜æ¬¾" },
    { root: "odottaa", type: "wait", imperf: { hÃ¤n: "odotti" }, neg_part: "odottanut", zh: "ç­‰å¾…" }
];

const objects = [
    // æ¨¡å—2é£Ÿç‰©å’Œé¥®æ–™æ‰©å±•
    { nom: "omena", part: "omenaa", gen: "omenan", zh: "è‹¹æœ" },
    { nom: "kahvi", part: "kahvia", gen: "kahvin", zh: "å’–å•¡" },
    { nom: "leipÃ¤", part: "leipÃ¤Ã¤", gen: "leivÃ¤n", zh: "é¢åŒ…" },
    { nom: "maito", part: "maitoa", gen: "maidon", zh: "ç‰›å¥¶" },
    { nom: "juusto", part: "juustoa", gen: "juuston", zh: "å¥¶é…ª" },
    { nom: "liha", part: "lihaa", gen: "lihan", zh: "è‚‰" },
    { nom: "kala", part: "kalaa", gen: "kalan", zh: "é±¼" },
    { nom: "pizza", part: "pizzaa", gen: "pizzan", zh: "æ¯”è¨" },
    { nom: "keitto", part: "keittoa", gen: "keiton", zh: "æ±¤" },
    { nom: "vesi", part: "vettÃ¤", gen: "veden", zh: "æ°´" },
    { nom: "olut", part: "olutta", gen: "oluen", zh: "å•¤é…’" },
    { nom: "viini", part: "viiniÃ¤", gen: "viinin", zh: "è‘¡è„é…’" },
    
    // å­¦ä¹ å’Œå·¥ä½œç‰©å“
    { nom: "kirja", part: "kirjaa", gen: "kirjan", zh: "ä¹¦" },
    { nom: "kirje", part: "kirjettÃ¤", gen: "kirjeen", zh: "ä¿¡" },
    { nom: "kuva", part: "kuvaa", gen: "kuvan", zh: "å›¾ç‰‡" },
    { nom: "paperi", part: "paperia", gen: "paperin", zh: "çº¸" },
    { nom: "kynÃ¤", part: "kynÃ¤Ã¤", gen: "kynÃ¤n", zh: "ç¬”" },
    { nom: "tietokone", part: "tietokonetta", gen: "tietokoneen", zh: "ç”µè„‘" },
    { nom: "puhelin", part: "puhelinta", gen: "puhelimen", zh: "ç”µè¯" },
    { nom: "sanomalehti", part: "sanomalehteÃ¤", gen: "sanomalehden", zh: "æŠ¥çº¸" },
    { nom: "lehti", part: "lehteÃ¤", gen: "lehden", zh: "æ‚å¿—" },
    
    // äº¤é€šå’Œæ—…è¡Œ
    { nom: "auto", part: "autoa", gen: "auton", zh: "è½¦" },
    { nom: "bussi", part: "bussia", gen: "bussin", zh: "å…¬äº¤è½¦" },
    { nom: "juna", part: "junaa", gen: "junan", zh: "ç«è½¦" },
    { nom: "lippu", part: "lippua", gen: "lipun", zh: "ç¥¨" },
    { nom: "polkupyÃ¶rÃ¤", part: "polkupyÃ¶rÃ¤Ã¤", gen: "polkupyÃ¶rÃ¤n", zh: "è‡ªè¡Œè½¦" },
    { nom: "avain", part: "avainta", gen: "avaimen", zh: "é’¥åŒ™" },
    { nom: "laukku", part: "laukkua", gen: "laukun", zh: "åŒ…" },
    { nom: "matkalaukku", part: "matkalaukkua", gen: "matkalaukun", zh: "è¡Œæç®±" },
    
    // å®¶å±…ç‰©å“
    { nom: "huone", part: "huonetta", gen: "huoneen", zh: "æˆ¿é—´" },
    { nom: "ovi", part: "ovea", gen: "oven", zh: "é—¨" },
    { nom: "ikkuna", part: "ikkunaa", gen: "ikkunan", zh: "çª—æˆ·" },
    { nom: "pÃ¶ytÃ¤", part: "pÃ¶ytÃ¤Ã¤", gen: "pÃ¶ydÃ¤n", zh: "æ¡Œå­" },
    { nom: "tuoli", part: "tuolia", gen: "tuolin", zh: "æ¤…å­" },
    { nom: "astia", part: "astiaa", gen: "astian", zh: "é¤å…·" },
    { nom: "lautanen", part: "lautasta", gen: "lautasen", zh: "ç›˜å­" },
    { nom: "kuppi", part: "kuppia", gen: "kupin", zh: "æ¯å­" },
    
    // å¨±ä¹å’Œä¼‘é—²
    { nom: "musiikki", part: "musiikkia", gen: "musiikin", zh: "éŸ³ä¹" },
    { nom: "elokuva", part: "elokuvaa", gen: "elokuvan", zh: "ç”µå½±" },
    { nom: "peli", part: "peliÃ¤", gen: "pelin", zh: "æ¸¸æˆ" },
    { nom: "urheilu", part: "urheilua", gen: "urheilun", zh: "è¿åŠ¨" },
    
    // æŠ½è±¡æ¦‚å¿µ
    { nom: "tyÃ¶", part: "tyÃ¶tÃ¤", gen: "tyÃ¶n", zh: "å·¥ä½œ" },
    { nom: "tehtÃ¤vÃ¤", part: "tehtÃ¤vÃ¤Ã¤", gen: "tehtÃ¤vÃ¤n", zh: "ä»»åŠ¡" },
    { nom: "asia", part: "asiaa", gen: "asian", zh: "äº‹æƒ…" },
    { nom: "ongelma", part: "ongelmaa", gen: "ongelman", zh: "é—®é¢˜" },
    { nom: "vastaus", part: "vastausta", gen: "vastauksen", zh: "ç­”æ¡ˆ" },
    { nom: "aika", part: "aikaa", gen: "ajan", zh: "æ—¶é—´" },
    { nom: "raha", part: "rahaa", gen: "rahan", zh: "é’±" }
];

const spatialPhrases = [
    // æ¨¡å—3 - é™æ€ä½ç½® (missÃ¤?)
    { type: "missÃ¤", fi: "kotona", zh: "åœ¨å®¶" },
    { type: "missÃ¤", fi: "kaupassa", zh: "åœ¨å•†åº—é‡Œ" },
    { type: "missÃ¤", fi: "puistossa", zh: "åœ¨å…¬å›­é‡Œ" },
    { type: "missÃ¤", fi: "ravintolassa", zh: "åœ¨é¤å…é‡Œ" },
    { type: "missÃ¤", fi: "koulussa", zh: "åœ¨å­¦æ ¡" },
    { type: "missÃ¤", fi: "yliopistossa", zh: "åœ¨å¤§å­¦" },
    { type: "missÃ¤", fi: "sairaalassa", zh: "åœ¨åŒ»é™¢" },
    { type: "missÃ¤", fi: "kirjastossa", zh: "åœ¨å›¾ä¹¦é¦†" },
    { type: "missÃ¤", fi: "museossa", zh: "åœ¨åšç‰©é¦†" },
    { type: "missÃ¤", fi: "teatterissa", zh: "åœ¨å‰§é™¢" },
    { type: "missÃ¤", fi: "elokuvateatterissa", zh: "åœ¨ç”µå½±é™¢" },
    { type: "missÃ¤", fi: "hotelissa", zh: "åœ¨é…’åº—" },
    { type: "missÃ¤", fi: "asemalla", zh: "åœ¨è½¦ç«™" },
    { type: "missÃ¤", fi: "lentokentÃ¤llÃ¤", zh: "åœ¨æœºåœº" },
    { type: "missÃ¤", fi: "baarissa", zh: "åœ¨é…’å§" },
    { type: "missÃ¤", fi: "kahvilassa", zh: "åœ¨å’–å•¡å…" },
    { type: "missÃ¤", fi: "toimistossa", zh: "åœ¨åŠå…¬å®¤" },
    { type: "missÃ¤", fi: "huoneessa", zh: "åœ¨æˆ¿é—´é‡Œ" },
    { type: "missÃ¤", fi: "keittiÃ¶ssÃ¤", zh: "åœ¨å¨æˆ¿" },
    { type: "missÃ¤", fi: "olohuoneessa", zh: "åœ¨å®¢å…" },
    { type: "missÃ¤", fi: "makuuhuoneessa", zh: "åœ¨å§å®¤" },
    { type: "missÃ¤", fi: "kylpyhuoneessa", zh: "åœ¨æµ´å®¤" },
    { type: "missÃ¤", fi: "pÃ¶ydÃ¤llÃ¤", zh: "åœ¨æ¡Œå­ä¸Š" },
    { type: "missÃ¤", fi: "tuolilla", zh: "åœ¨æ¤…å­ä¸Š" },
    { type: "missÃ¤", fi: "sohvalla", zh: "åœ¨æ²™å‘ä¸Š" },
    { type: "missÃ¤", fi: "sÃ¤ngyllÃ¤", zh: "åœ¨åºŠä¸Š" },
    { type: "missÃ¤", fi: "lattialla", zh: "åœ¨åœ°æ¿ä¸Š" },
    
    // æ¨¡å—3 - å»å‘ (mihin?)
    { type: "mihin", fi: "kotiin", zh: "å›å®¶" },
    { type: "mihin", fi: "kauppaan", zh: "å»å•†åº—" },
    { type: "mihin", fi: "tyÃ¶hÃ¶n", zh: "å»ä¸Šç­" },
    { type: "mihin", fi: "kouluun", zh: "å»å­¦æ ¡" },
    { type: "mihin", fi: "yliopistoon", zh: "å»å¤§å­¦" },
    { type: "mihin", fi: "sairaalaan", zh: "å»åŒ»é™¢" },
    { type: "mihin", fi: "kirjastoon", zh: "å»å›¾ä¹¦é¦†" },
    { type: "mihin", fi: "museoon", zh: "å»åšç‰©é¦†" },
    { type: "mihin", fi: "ravintolaan", zh: "å»é¤å…" },
    { type: "mihin", fi: "puistoon", zh: "å»å…¬å›­" },
    { type: "mihin", fi: "asemalle", zh: "å»è½¦ç«™" },
    { type: "mihin", fi: "lentokentÃ¤lle", zh: "å»æœºåœº" },
    { type: "mihin", fi: "Helsinkiin", zh: "å»èµ«å°”è¾›åŸº" },
    { type: "mihin", fi: "Turkuun", zh: "å»å›¾å°”åº“" },
    { type: "mihin", fi: "Tampereelle", zh: "å»å¦ä½©é›·" },
    { type: "mihin", fi: "huoneeseen", zh: "å»æˆ¿é—´" },
    { type: "mihin", fi: "keittiÃ¶Ã¶n", zh: "å»å¨æˆ¿" },
    { type: "mihin", fi: "pÃ¶ydÃ¤lle", zh: "åˆ°æ¡Œå­ä¸Š" },
    { type: "mihin", fi: "tuolille", zh: "åˆ°æ¤…å­ä¸Š" },
    { type: "mihin", fi: "lattialle", zh: "åˆ°åœ°æ¿ä¸Š" },
    
    // æ¨¡å—3 - æ¥æº (mistÃ¤?)
    { type: "mistÃ¤", fi: "kotoa", zh: "ä»å®¶" },
    { type: "mistÃ¤", fi: "kaupasta", zh: "ä»å•†åº—" },
    { type: "mistÃ¤", fi: "tyÃ¶stÃ¤", zh: "ä»å·¥ä½œ" },
    { type: "mistÃ¤", fi: "koulusta", zh: "ä»å­¦æ ¡" },
    { type: "mistÃ¤", fi: "yliopistolta", zh: "ä»å¤§å­¦" },
    { type: "mistÃ¤", fi: "sairaalasta", zh: "ä»åŒ»é™¢" },
    { type: "mistÃ¤", fi: "kirjastosta", zh: "ä»å›¾ä¹¦é¦†" },
    { type: "mistÃ¤", fi: "museosta", zh: "ä»åšç‰©é¦†" },
    { type: "mistÃ¤", fi: "ravintolasta", zh: "ä»é¤å…" },
    { type: "mistÃ¤", fi: "puistosta", zh: "ä»å…¬å›­" },
    { type: "mistÃ¤", fi: "asemalta", zh: "ä»è½¦ç«™" },
    { type: "mistÃ¤", fi: "lentokentÃ¤ltÃ¤", zh: "ä»æœºåœº" },
    { type: "mistÃ¤", fi: "HelsingistÃ¤", zh: "ä»èµ«å°”è¾›åŸº" },
    { type: "mistÃ¤", fi: "Turusta", zh: "ä»å›¾å°”åº“" },
    { type: "mistÃ¤", fi: "Tampereelta", zh: "ä»å¦ä½©é›·" },
    { type: "mistÃ¤", fi: "huoneesta", zh: "ä»æˆ¿é—´" },
    { type: "mistÃ¤", fi: "keittiÃ¶stÃ¤", zh: "ä»å¨æˆ¿" },
    { type: "mistÃ¤", fi: "pÃ¶ydÃ¤ltÃ¤", zh: "ä»æ¡Œå­ä¸Š" },
    { type: "mistÃ¤", fi: "tuolilta", zh: "ä»æ¤…å­ä¸Š" },
    { type: "mistÃ¤", fi: "lattialta", zh: "ä»åœ°æ¿ä¸Š" }
];

const reasonClauses = [
    // æ¨¡å—2åŸºç¡€éœ€æ±‚è¡¨è¾¾
    { fi: "halusin", zh: "æƒ³è¦" },
    { fi: "tarvitsin", zh: "éœ€è¦" },
    { fi: "en halunnut", zh: "ä¸æƒ³è¦" },
    { fi: "en tarvinnut", zh: "ä¸éœ€è¦" },
    { fi: "pidin siitÃ¤", zh: "å–œæ¬¢å®ƒ" },
    { fi: "en pitÃ¤nyt siitÃ¤", zh: "ä¸å–œæ¬¢å®ƒ" },
    
    // æ‰©å±•åŸå› ä»å¥
    { fi: "olin vÃ¤synyt", zh: "ç´¯äº†" },
    { fi: "olin nÃ¤lkÃ¤inen", zh: "é¥¿äº†" },
    { fi: "olin janoinen", zh: "æ¸´äº†" },
    { fi: "olin kiireinen", zh: "å¿™" },
    { fi: "en ollut kotona", zh: "ä¸åœ¨å®¶" },
    { fi: "en ollut kiireinen", zh: "ä¸å¿™" },
    { fi: "en ehtinyt", zh: "æ¥ä¸åŠ" },
    { fi: "unohdin", zh: "å¿˜è®°äº†" },
    { fi: "en muistanut", zh: "ä¸è®°å¾—" },
    { fi: "oli liian kallis", zh: "å¤ªè´µäº†" },
    { fi: "oli liian vaikea", zh: "å¤ªéš¾äº†" },
    { fi: "oli liian kaukana", zh: "å¤ªè¿œäº†" },
    { fi: "sÃ¤Ã¤li huono", zh: "å¤©æ°”ä¸å¥½" },
    { fi: "ei ollut aikaa", zh: "æ²¡æœ‰æ—¶é—´" },
    { fi: "ei ollut rahaa", zh: "æ²¡æœ‰é’±" }
];

const imperfEndings = {
    minÃ¤: "n", sinÃ¤: "t", hÃ¤n: "", me: "mme", te: "tte", he: "vat"
};
const negWords = {
    minÃ¤: "en", sinÃ¤: "et", hÃ¤n: "ei", me: "emme", te: "ette", he: "eivÃ¤t"
};
const negPartEndings = {
    minÃ¤: "", sinÃ¤: "", hÃ¤n: "", me: "neet", te: "neet", he: "neet"
};

// =============================================
//  LOGIC LAYER
// =============================================

let currentAlibi = {};
let currentLogEntry = {};

function getRandomElement(arr) {
    return arr[Math.floor(Math.random() * arr.length)];
}

// --- TTS Function ---
function speakText(text) {
    if (!text || text === '...') return;
    const cleanText = text.replace(/<[^>]*>/g, '');
    if ('speechSynthesis' in window) {
        const utterance = new SpeechSynthesisUtterance(cleanText);
        utterance.lang = 'fi-FI';
        utterance.rate = 0.9;
        speechSynthesis.speak(utterance);
    } else {
        alert('æŠ±æ­‰ï¼Œæ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒè¯­éŸ³åŠŸèƒ½ã€‚');
    }
}

// --- Translation Toggle ---
function toggleTranslation(elementId) {
    const element = document.getElementById(elementId);
    element.style.display = (element.style.display === 'none' || element.style.display === '') ? 'block' : 'none';
}

// --- Verb Conjugation Helper ---
function getVerbForm(verbRoot, person, isPositive) {
    // This is a simplified conjugator for this demo
    let stem = verbRoot;
    let imperfBase = "";
    
    // Simplified logic for imperf stem
    if (verbRoot.endsWith('a')) { // lukea -> luki, ostaa -> osti
        imperfBase = verbRoot.slice(0, -1) + 'i';
    } else if (verbRoot.endsWith('dÃ¤')) { // syÃ¶dÃ¤ -> sÃ¶i
        imperfBase = verbRoot.slice(0, -2) + 'i';
    } else if (verbRoot.endsWith('nnÃ¤')) { // mennÃ¤ -> meni
        imperfBase = verbRoot.slice(0, -3) + 'i';
    } else if (verbRoot.endsWith('hdÃ¤')) { // tehdÃ¤ -> teki
        imperfBase = verbRoot.slice(0, -3) + 'ki';
    } else {
        imperfBase = verbRoot + 'i'; // Fallback
    }

    if (isPositive) {
        if (person === 'hÃ¤n') return imperfBase;
        return imperfBase + imperfEndings[person];
    } else {
        // Negative
        let negPartBase = "";
        if (verbRoot.endsWith('ut') || verbRoot.endsWith('yt')) {
             negPartBase = verbRoot;
        } else if (['l','n','r','s','t'].includes(verbRoot.slice(-2,-1)) && verbRoot.endsWith('a')) { //antaa -> antanut
            negPartBase = verbRoot.slice(0,-1) + 'anut';
        } else { // Fallback, good for syÃ¶dÃ¤, juoda etc.
            negPartBase = verbRoot.slice(0,-1) + (['a','o','u'].includes(verbRoot.slice(-2,-1)) ? 'anut' : 'enyt');
            if (verbRoot === 'syÃ¶dÃ¤') negPartBase = 'syÃ¶nyt';
            if (verbRoot === 'juoda') negPartBase = 'juonut';
            if (verbRoot === 'lukea') negPartBase = 'lukenut';
            if (verbRoot === 'mennÃ¤') negPartBase = 'mennyt';
            if (verbRoot === 'tehdÃ¤') negPartBase = 'tehnyt';
        }

        return negWords[person] + " " + negPartBase.slice(0,-1) + (['me','te','he'].includes(person) ? 'eet' : negPartBase.slice(-1));
    }
}


// --- STAGE 1 LOGIC ---
function generateNewAlibi() {
    const subjectData = getRandomElement(subjects);
    const verbData = getRandomElement(verbs);
    const objectData = getRandomElement(objects);

    const isPositive = Math.random() < 0.5;

    let statement, rebuttal, statement_zh, rebuttal_zh;

    // A more robust verb form getter
    const getImperf = (v_root, s_pers) => {
        // Simplified, but covers some cases
        let base = v_root.imperf.hÃ¤n;
        if (s_pers === 'hÃ¤n') return base;
        if (base.endsWith('i')) return base + imperfEndings[s_pers];
        return base; // Fallback
    }
    const getNeg = (v_root, s_pers) => {
        let ending = (s_pers === 'me' || s_pers === 'te' || s_pers === 'he') ? 'eet' : '';
        return `${negWords[s_pers]} ${v_root.neg_part}${ending}`;
    }

    if (isPositive) {
        statement = `<span class="highlight">${getImperf(verbData, subjectData.fi_pers)}</span> ${objectData.gen}`;
        rebuttal = `Ei, ${subjectData.fi} <span class="highlight-neg">${getNeg(verbData, subjectData.fi_pers)}</span> ${objectData.part}.`;
        statement_zh = `${subjectData.zh}${verbData.zh}äº†${objectData.zh}ã€‚`;
        rebuttal_zh = `ä¸ï¼Œ${subjectData.zh}æ²¡${verbData.zh}${objectData.zh}ã€‚`;
    } else {
        statement = `<span class="highlight-neg">${getNeg(verbData, subjectData.fi_pers)}</span> ${objectData.part}`;
        rebuttal = `KyllÃ¤, ${subjectData.fi} <span class="highlight">${getImperf(verbData, subjectData.fi_pers)}</span> ${objectData.gen}.`;
        statement_zh = `${subjectData.zh}æ²¡${verbData.zh}${objectData.zh}ã€‚`;
        rebuttal_zh = `æ˜¯çš„ï¼Œ${subjectData.zh}${verbData.zh}äº†${objectData.zh}ã€‚`;
    }

    currentAlibi = {
        statement: `${subjectData.fi} ${statement}.`,
        statement_zh: statement_zh,
        rebuttal: rebuttal,
        rebuttal_zh: rebuttal_zh
    };

    document.getElementById('suspect-statement').innerHTML = currentAlibi.statement;
    document.getElementById('suspect-translation').textContent = currentAlibi.statement_zh;
    document.getElementById('correct-rebuttal').style.display = 'none';
    document.getElementById('rebuttal-statement').innerHTML = '';
    document.getElementById('rebuttal-translation').textContent = '';
    
    // è‡ªåŠ¨æ’­æ”¾æ–°çš„å«Œç–‘äººé™ˆè¿°
    setTimeout(() => {
        speakText(currentAlibi.statement);
    }, 100);
}

function checkAlibi() {
    document.getElementById('rebuttal-statement').innerHTML = currentAlibi.rebuttal;
    document.getElementById('rebuttal-translation').textContent = currentAlibi.rebuttal_zh;
    document.getElementById('correct-rebuttal').style.display = 'block';
    
    // è‡ªåŠ¨æ’­æ”¾åé©³
    setTimeout(() => {
        speakText(currentAlibi.rebuttal);
    }, 100);
}

// --- STAGE 2 LOGIC ---
function generateLogEntry() {
    const templateType = Math.random();
    let entry, translation;

    const subject = getRandomElement(subjects);
    const verb = getRandomElement(verbs);
    const object = getRandomElement(objects);
    
    // æ›´å¼ºå¤§çš„åŠ¨è¯å˜ä½å‡½æ•°
    const getImperf = (v, s_pers) => {
        const base = v.imperf.hÃ¤n;
        if (s_pers === 'hÃ¤n') return base;
        if (s_pers === 'minÃ¤') return base + 'n';
        if (s_pers === 'sinÃ¤') return base + 't';
        if (s_pers === 'me') return base + 'mme';
        if (s_pers === 'te') return base + 'tte';
        if (s_pers === 'he') return base + 'vat';
        return base;
    };
    
    const getNeg = (v, s_pers) => {
        const ending = ['me','te','he'].includes(s_pers) ? 'neet' : '';
        return `${negWords[s_pers]} ${v.neg_part}${ending}`;
    };

    if (templateType < 0.15) { // Template A: ç®€å•è¿‡å»æ—¶ (è‚¯å®š)
        const vForm = getImperf(verb, subject.fi_pers);
        entry = `${subject.fi} <span class="highlight">${vForm}</span> ${object.gen} eilen.`;
        translation = `${subject.zh}æ˜¨å¤©${verb.zh}äº†${object.zh}ã€‚`;

    } else if (templateType < 0.30) { // Template B: ç®€å•è¿‡å»æ—¶ (å¦å®š)
        const vForm = getNeg(verb, subject.fi_pers);
        entry = `${subject.fi} <span class="highlight-neg">${vForm}</span> ${object.part} eilen.`;
        translation = `${subject.zh}æ˜¨å¤©æ²¡${verb.zh}${object.zh}ã€‚`;

    } else if (templateType < 0.45) { // Template C: æ—¶é—´+ç©ºé—´ (é™æ€)
        const sp = getRandomElement(spatialPhrases.filter(p => p.type === 'missÃ¤'));
        const isPositive = Math.random() > 0.5;
        
        if (isPositive) {
            const vForm = getImperf(verb, subject.fi_pers);
            entry = `${subject.fi} <span class="highlight">${vForm}</span> ${object.gen} <span class="highlight-space">${sp.fi}</span>.`;
            translation = `${subject.zh}${sp.zh}${verb.zh}äº†${object.zh}ã€‚`;
        } else {
            const vForm = getNeg(verb, subject.fi_pers);
            entry = `${subject.fi} <span class="highlight-neg">${vForm}</span> ${object.part} <span class="highlight-space">${sp.fi}</span>.`;
            translation = `${subject.zh}æ²¡${sp.zh}${verb.zh}${object.zh}ã€‚`;
        }

    } else if (templateType < 0.60) { // Template D: ç©ºé—´ç§»åŠ¨ (æ¨¡å—3é«˜çº§)
        const movementVerbs = verbs.filter(v => ['go', 'come', 'leave', 'drive', 'walk', 'run', 'travel'].includes(v.type));
        if (movementVerbs.length > 0) {
            const moveVerb = getRandomElement(movementVerbs);
            const spType = getRandomElement(['mihin', 'mistÃ¤']);
            const sp = getRandomElement(spatialPhrases.filter(p => p.type === spType));
            
            const isPositive = Math.random() > 0.5;
            if (isPositive) {
                const vForm = getImperf(moveVerb, subject.fi_pers);
                entry = `${subject.fi} <span class="highlight">${vForm}</span> <span class="highlight-space">${sp.fi}</span> aamulla.`;
                translation = `${subject.zh}æ—©ä¸Š${sp.zh}${moveVerb.zh}äº†ã€‚`;
            } else {
                const vForm = getNeg(moveVerb, subject.fi_pers);
                entry = `${subject.fi} <span class="highlight-neg">${vForm}</span> <span class="highlight-space">${sp.fi}</span> aamulla.`;
                translation = `${subject.zh}æ—©ä¸Šæ²¡${sp.zh}${moveVerb.zh}ã€‚`;
            }
        } else {
            // Fallback to template C
            const sp = getRandomElement(spatialPhrases.filter(p => p.type === 'missÃ¤'));
            const vForm = getImperf(verb, subject.fi_pers);
            entry = `${subject.fi} <span class="highlight">${vForm}</span> ${object.gen} <span class="highlight-space">${sp.fi}</span>.`;
            translation = `${subject.zh}${sp.zh}${verb.zh}äº†${object.zh}ã€‚`;
        }

    } else if (templateType < 0.80) { // Template E: æ—¶é—´+ç©ºé—´+åŸå›  (ä¸­çº§å¤æ‚åº¦)
        const sp = getRandomElement(spatialPhrases.filter(p => p.type === 'missÃ¤'));
        const reason = getRandomElement(reasonClauses);
        const isPositive = Math.random() > 0.5;
        
        if (isPositive) {
            const vForm = getImperf(verb, subject.fi_pers);
            entry = `${subject.fi} <span class="highlight">${vForm}</span> ${object.gen} <span class="highlight-space">${sp.fi}</span>, koska <span class="highlight-reason">${reason.fi}</span>.`;
            translation = `${subject.zh}${sp.zh}${verb.zh}äº†${object.zh}ï¼Œå› ä¸ºä»–/å¥¹${reason.zh}ã€‚`;
        } else {
            const vForm = getNeg(verb, subject.fi_pers);
            entry = `${subject.fi} <span class="highlight-neg">${vForm}</span> ${object.part} <span class="highlight-space">${sp.fi}</span>, koska <span class="highlight-reason">${reason.fi}</span>.`;
            translation = `${subject.zh}æ²¡${sp.zh}${verb.zh}${object.zh}ï¼Œå› ä¸ºä»–/å¥¹${reason.zh}ã€‚`;
        }

    } else { // Template F: ç»ˆæå¤æ‚å¥ (é«˜çº§æ•´åˆ)
        const subject2 = getRandomElement(subjects);
        const verb2 = getRandomElement(verbs);
        const object2 = getRandomElement(objects);
        const sp1 = getRandomElement(spatialPhrases.filter(p => p.type === 'missÃ¤'));
        const sp2 = getRandomElement(spatialPhrases.filter(p => p.type === 'mihin'));
        
        const vForm1 = getImperf(verb, subject.fi_pers);
        const vForm2 = Math.random() > 0.5 ? getImperf(verb2, subject2.fi_pers) : getNeg(verb2, subject2.fi_pers);
        
        if (vForm2.includes('en ') || vForm2.includes('ei ') || vForm2.includes('emme ')) {
            // åŒ…å«å¦å®šçš„å¤åˆå¥
            entry = `Kun ${subject.fi} <span class="highlight">${vForm1}</span> ${object.gen} <span class="highlight-space">${sp1.fi}</span>, ${subject2.fi} <span class="highlight-neg">${vForm2}</span> ${object2.part} <span class="highlight-space">${sp2.fi}</span>.`;
            translation = `å½“${subject.zh}${sp1.zh}${verb.zh}${object.zh}æ—¶ï¼Œ${subject2.zh}æ²¡æœ‰${sp2.zh}${verb2.zh}${object2.zh}ã€‚`;
        } else {
            // åŒé‡è‚¯å®šçš„å¤åˆå¥
            entry = `Kun ${subject.fi} <span class="highlight">${vForm1}</span> ${object.gen} <span class="highlight-space">${sp1.fi}</span>, ${subject2.fi} <span class="highlight">${vForm2}</span> ${object2.gen} <span class="highlight-space">${sp2.fi}</span>.`;
            translation = `å½“${subject.zh}${sp1.zh}${verb.zh}${object.zh}æ—¶ï¼Œ${subject2.zh}${sp2.zh}${verb2.zh}äº†${object2.zh}ã€‚`;
        }
    }
    
    // æ˜¾ç¤ºå†…å®¹å¹¶è‡ªåŠ¨æ’­æ”¾
    document.getElementById('log-entry-display').innerHTML = entry;
    document.getElementById('log-translation').textContent = translation;
    
    // è‡ªåŠ¨æ’­æ”¾æ–°ç”Ÿæˆçš„å¥å­
    setTimeout(() => {
        speakText(entry);
    }, 100);
}

// --- INITIALIZATION ---
window.onload = () => {
    generateNewAlibi();
    generateLogEntry();
};

</script>
</body>
</html>