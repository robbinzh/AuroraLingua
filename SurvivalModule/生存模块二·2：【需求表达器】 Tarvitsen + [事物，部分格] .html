<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>芬兰语入门 - 我需要表达系统 (TTS)</title>
    <style>
        body {
            font-family: "Microsoft YaHei", sans-serif;
            line-height: 1.6;
            margin: 20px auto;
            max-width: 900px;
            padding: 0 20px;
        }
        h1, h2, h3 {
            color: #2c3e50;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            overflow-x: auto;
            display: block;
            margin-bottom: 20px;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }
        thead {
            background-color: #f4f4f4;
        }
        details {
            margin-bottom: 10px;
        }
        .example {
            background-color: #f9f9f9;
            padding: 10px;
            border-left: 4px solid #3498db;
            margin: 10px 0;
        }
        .tts-button {
            background: none;
            border: none;
            cursor: pointer;
            font-size: 1.2em;
            margin-left: 5px;
            padding: 0;
            display: inline-block;
            vertical-align: middle;
        }
        .tts-button:hover {
            opacity: 0.7;
        }
        .debug-section {
            background-color: #fffbf0;
            border: 2px solid #ffa500;
            padding: 15px;
            margin: 20px 0;
            border-radius: 8px;
        }
        .debug-button {
            background-color: #4CAF50;
            color: white;
            padding: 8px 16px;
            margin: 5px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        .debug-button:hover {
            background-color: #45a049;
        }
    </style>
</head>
<body>

<h1>🧱 模块二·2：【需求表达器】"Tarvitsen + [事物，部分格]"</h1>

<!-- TTS调试区域 -->
<div class="debug-section">
    <h3>🔧 TTS功能测试</h3>
    <p>如果TTS按钮没有声音，请先测试以下功能：</p>
    <button class="debug-button" onclick="testBasicTTS()">测试基本TTS</button>
    <button class="debug-button" onclick="testFinnishTTS()">测试芬兰语TTS</button>
    <button class="debug-button" onclick="listVoices()">查看可用语音</button>
    <button class="debug-button" onclick="removeDebugSection()">移除调试区域</button>
    <div id="debug-output" style="margin-top: 10px; padding: 10px; background-color: #f0f0f0; border-radius: 4px; font-family: monospace; font-size: 12px; max-height: 200px; overflow-y: auto;"></div>
</div>

<hr>

<section id="cognitive-core">
    <h2>🧠 认知绑定核心：</h2>
    <p><strong>“Haluan” 是我想要，“Tarvitsen” 是我需要。</strong></p>
    <p>这两者都在用【部分格】，但背后的心理驱动不同：</p>
    <table>
        <thead>
            <tr>
                <th>类型</th>
                <th>意图</th>
                <th>芬兰语结构</th>
                <th>中文映射</th>
            </tr>
        </thead>
        <tbody>
            <tr>
                <td>Haluan + 部分格</td>
                <td>想要 → 意愿</td>
                <td>Haluan kahvia</td>
                <td>我想要点咖啡</td>
            </tr>
            <tr>
                <td>Tarvitsen + 部分格</td>
                <td>需要 → 存在性</td>
                <td>Tarvitsen lippua</td>
                <td>我需要张票</td>
            </tr>
        </tbody>
    </table>
</section>

<hr>

<section id="vocab-table">
    <h2>🧬 高频日常用品词汇表（部分格形式 + 原形 + 中文）</h2>
    <p>以下词汇是你在芬兰日常生活中“需要”用到最多的。</p>
    <table>
        <thead>
            <tr>
                <th>原形</th>
                <th>部分格</th>
                <th>中文</th>
                <th>使用场景示例</th>
            </tr>
        </thead>
        <tbody>
            <tr><td>lippu</td><td>lippua</td><td>票（车票、入场票）</td><td>Tarvitsen lippua.</td></tr>
            <tr><td>avain</td><td>avainta</td><td>钥匙</td><td>Tarvitsen avainta.</td></tr>
            <tr><td>laukku</td><td>laukkua</td><td>包、手提包</td><td>Tarvitsen laukkua.</td></tr>
            <tr><td>puhelin</td><td>puhelinta</td><td>手机</td><td>Tarvitsen puhelinta.</td></tr>
            <tr><td>kirje</td><td>kirjettä</td><td>信、邮件</td><td>Tarvitsen kirjettä.</td></tr>
            <tr><td>paperi</td><td>paperia</td><td>纸张、文档</td><td>Tarvitsen paperia.</td></tr>
            <tr><td>tieto</td><td>tietoa</td><td>信息、数据</td><td>Tarvitsen tietoa.</td></tr>
            <tr><td>apu</td><td>apua</td><td>帮助</td><td>Tarvitsen apua.</td></tr>
            <tr><td>aika</td><td>aikaa</td><td>时间</td><td>Tarvitsen aikaa.</td></tr>
            <tr><td>lomake</td><td>lomaketta</td><td>表格</td><td>Tarvitsen lomaketta.</td></tr>
            <tr><td>kartta</td><td>karttaa</td><td>地图</td><td>Tarvitsen karttaa.</td></tr>
            <tr><td>laturi</td><td>laturia</td><td>充电器</td><td>Tarvitsen laturia.</td></tr>
            <tr><td>lääke</td><td>lääkettä</td><td>药</td><td>Tarvitsen lääkettä.</td></tr>
            <tr><td>resepti</td><td>reseptiä</td><td>处方</td><td>Tarvitsen reseptiä.</td></tr>
            <tr><td>neuvo</td><td>neuvoa</td><td>建议</td><td>Tarvitsen neuvoa.</td></tr>
            <tr><td>raha</td><td>rahaa</td><td>钱</td><td>Tarvitsen rahaa.</td></tr>
            <tr><td>tila</td><td>tilaa</td><td>空间</td><td>Tarvitsen tilaa.</td></tr>
            <tr><td>lepo</td><td>lepoa</td><td>休息</td><td>Tarvitsen lepoa.</td></tr>
            <tr><td>uni</td><td>unta</td><td>睡眠</td><td>Tarvitsen unta.</td></tr>
            <tr><td>hiljaisuus</td><td>hiljaisuutta</td><td>安静</td><td>Tarvitsen hiljaisuutta.</td></tr>
            <tr><td>juoma</td><td>juomaa</td><td>饮料（泛指）</td><td>Tarvitsen juomaa.</td></tr>
            <tr><td>ruoka</td><td>ruokaa</td><td>食物（泛指）</td><td>Tarvitsen ruokaa.</td></tr>
            <tr><td>vesi</td><td>vettä</td><td>水（尽管Haluan更常用，这里也适用）</td><td>Tarvitsen vettä.</td></tr>
            <tr><td>sokeri</td><td>sokeria</td><td>糖（有时用于补充咖啡）</td><td>Tarvitsen sokeria.</td></tr>
        </tbody>
    </table>
</section>

<hr>

<section id="core-blocks">
    <h2>🧩 核心语块模板（绑定你的真实需求）</h2>
    <p>“Tarvitsen”不是礼貌的“我想需要”，而是<strong>生存驱动的“我得用”</strong>，就像中文里说“我得拿包”、“我得用个手机”。</p>
    <table>
        <thead>
            <tr>
                <th>语块</th>
                <th>中文映射</th>
                <th>场景</th>
            </tr>
        </thead>
        <tbody>
            <tr><td>Tarvitsen lippua.</td><td>我需要一张票。</td><td>买票、坐车、入场</td></tr>
            <tr><td>Tarvitsen avainta.</td><td>我需要钥匙。</td><td>找钥匙、租房、登记</td></tr>
            <tr><td>Tarvitsen laukkua.</td><td>我需要一个包。</td><td>买东西、旅行、装货</td></tr>
            <tr><td>Tarvitsen apua.</td><td>我需要帮忙。</td><td>遇到困难时</td></tr>
            <tr><td>Tarvitsen tietoa.</td><td>我需要信息。</td><td>邮局、签证处、柜台</td></tr>
            <tr><td>Tarvitsen kirjettä.</td><td>我需要一封信。</td><td>书写、邮寄、申请</td></tr>
            <tr><td>Tarvitsen paperia.</td><td>我需要纸。</td><td>官方场合、打印店</td></tr>
            <tr><td>Tarvitsen aikaa.</td><td>我需要时间。</td><td>拖延、请求宽限</td></tr>
            <tr><td>Tarvitsen lomaketta.</td><td>我需要表格。</td><td>官方申请、注册</td></tr>
            <tr><td>Tarvitsen jotain.</td><td>我需要点什么。</td><td>通用表达、应急使用</td></tr>
            <tr><td>Tarvitsen laturia.</td><td>我需要充电器。</td><td>手机没电时</td></tr>
            <tr><td>Tarvitsen lääkettä.</td><td>我需要药。</td><td>生病或紧急情况</td></tr>
            <tr><td>Tarvitsen rahaa.</td><td>我需要钱。</td><td>支付或紧急情况</td></tr>
            <tr><td>Tarvitsen hiljaisuutta.</td><td>我需要安静。</td><td>噪音环境</td></tr>
            <tr><td>Tarvitsen lepoa.</td><td>我需要休息。</td><td>疲惫时</td></tr>
        </tbody>
    </table>
</section>

<hr>

<section id="scenario-training">
    <h2>🧪 场景训练套件（生存级）</h2>
    <div class="example">
        <h3>📍 场景 1：公共交通站</h3>
        <p><span class="speakable-finnish">Tarvitsen lippua.</span></p>
        <p>[掏出零钱 + 指向售票机] → <span class="speakable-finnish">"Tässä lippua?"</span></p>
    </div>
    <div class="example">
        <h3>📍 场景 2：租房 / 房间 / 宿舍</h3>
        <p><span class="speakable-finnish">En löydä avainta.</span></p>
        <p><span class="speakable-finnish">Tarvitsen avainta!</span></p>
        <p><span class="speakable-finnish">Missä on avain?</span></p>
    </div>
    <div class="example">
        <h3>📍 场景 3：购物 / 包 / 行李</h3>
        <p><span class="speakable-finnish">Tarvitsen laukkua.</span></p>
        <p><span class="speakable-finnish">Tämä laukku hyvä?</span></p>
        <p><span class="speakable-finnish">Onko tässä laukkuja?</span></p>
    </div>
    <div class="example">
        <h3>📍 场景 4：官方机构 / 邮局 / 政府部门</h3>
        <p><span class="speakable-finnish">Tarvitsen tietoa.</span></p>
        <p><span class="speakable-finnish">Tarvitsen lomaketta.</span></p>
        <p><span class="speakable-finnish">Minä en tiedä mitä tässä tarvitse.</span></p>
    </div>
    <div class="example">
        <h3>📍 场景 5：紧急情况 / 身体不适</h3>
        <p><span class="speakable-finnish">Tarvitsen apua.</span></p>
        <p><span class="speakable-finnish">Tarvitsen lääkettä.</span></p>
        <p><span class="speakable-finnish">Tarvitsen lepoa.</span></p>
    </div>
</section>

<hr>

<section id="body-binding">
    <h2>🧬 肢体绑定训练（Tarvitsen + 词）</h2>
    <p>语言不是从嘴中诞生的，是从身体中<strong>推出来的</strong>。</p>
    <table>
        <thead>
            <tr>
                <th>动作</th>
                <th>配套语言</th>
                <th>场景</th>
            </tr>
        </thead>
        <tbody>
            <tr><td>手伸向售票机</td><td><span class="speakable-finnish">Tarvitsen lippua.</span></td><td>坐车时</td></tr>
            <tr><td>摸口袋找钥匙</td><td><span class="speakable-finnish">Tarvitsen avainta.</span></td><td>进门时</td></tr>
            <tr><td>指着包</td><td><span class="speakable-finnish">Tämä laukku ok? Tarvitsen laukkua.</span></td><td>购物时</td></tr>
            <tr><td>手按文档</td><td><span class="speakable-finnish">Tarvitsen lomaketta.</span></td><td>办公室/邮局</td></tr>
            <tr><td>手指脑袋</td><td><span class="speakable-finnish">Tarvitsen tietoa.</span></td><td>问信息</td></tr>
            <tr><td>手掌在空中停顿</td><td><span class="speakable-finnish">En tiedä mitä tarvitse.</span></td><td>不确定时</td></tr>
            <tr><td>指向手机充电口</td><td><span class="speakable-finnish">Tarvitsen laturia.</span></td><td>手机没电时</td></tr>
            <tr><td>指向身体不适部位</td><td><span class="speakable-finnish">Tarvitsen lääkettä.</span></td><td>感到不适时</td></tr>
            <tr><td>比划钱的手势</td><td><span class="speakable-finnish">Tarvitsen rahaa.</span></td><td>需要付钱或借钱时</td></tr>
        </tbody>
    </table>
</section>

<hr>

<section id="structure-deformation">
    <h2>🧠 结构变形训练（不只是“Tarvitsen”）</h2>
    <p>一旦你掌握了Tarvitsen + 部分格，就要开始<strong>变形你的需求表达</strong>，以适配不同场景：</p>
    <table>
        <thead>
            <tr>
                <th>功能</th>
                <th>语块</th>
                <th>中文映射</th>
            </tr>
        </thead>
        <tbody>
            <tr><td>需要帮助</td><td><span class="speakable-finnish">Tarvitsen apua</span></td><td>需要帮助（是芬兰人最常听到的）</td></tr>
            <tr><td>需要时间</td><td><span class="speakable-finnish">Tarvitsen aikaa</span></td><td>请给我点时间</td></tr>
            <tr><td>需要信息</td><td><span class="speakable-finnish">Tarvitsen tietoa</span></td><td>我得查一下</td></tr>
            <tr><td>需要表格</td><td><span class="speakable-finnish">Tarvitsen lomaketta</span></td><td>我要填这个</td></tr>
            <tr><td>需要包</td><td><span class="speakable-finnish">Tarvitsen laukkua</span></td><td>我得找个包装东西</td></tr>
            <tr><td>需要钥匙</td><td><span class="speakable-finnish">Tarvitsen avainta</span></td><td>我得拿钥匙开门</td></tr>
            <tr><td>需要票</td><td><span class="speakable-finnish">Tarvitsen lippua</span></td><td>我得上车/入场</td></tr>
            <tr><td>需要信</td><td><span class="speakable-finnish">Tarvitsen kirjettä</span></td><td>我得写封信</td></tr>
            <tr><td>需要纸</td><td><span class="speakable-finnish">Tarvitsen paperia</span></td><td>我得填表格</td></tr>
            <tr><td>想要+需要混合</td><td><span class="speakable-finnish">Haluan ja tarvitsen</span></td><td>我想要也得用</td></tr>
            <tr><td>需要充电器</td><td><span class="speakable-finnish">Tarvitsen laturia</span></td><td>手机没电了</td></tr>
            <tr><td>需要药</td><td><span class="speakable-finnish">Tarvitsen lääkettä</span></td><td>生病了</td></tr>
            <tr><td>需要钱</td><td><span class="speakable-finnish">Tarvitsen rahaa</span></td><td>没钱了</td></tr>
            <tr><td>需要安静</td><td><span class="speakable-finnish">Tarvitsen hiljaisuutta</span></td><td>太吵了</td></tr>
        </tbody>
    </table>
</section>

<hr>

<section id="daily-bleeding-training">
    <h2>🧪 每日语言出血训练（实战唤醒）</h2>
    <h3>📅 第1周：植入“Tarvitsen”系统</h3>
    <ul>
        <li>每次遇到困难 → 说：<span class="speakable-finnish">"Tarvitsen apua."</span></li>
        <li>每次进邮局/柜台 → 说：<span class="speakable-finnish">"Tarvitsen tätä."</span>（指任意物品）</li>
        <li>每次在车站 → 说：<span class="speakable-finnish">"Tarvitsen lippua."</span></li>
        <li>手机没电时 → 说：<span class="speakable-finnish">"Tarvitsen laturia."</span></li>
    </ul>
    <h3>📅 第2周：混合"Tarvitsen"与"Minä"</h3>
    <ul>
        <li>练习：<span class="speakable-finnish">"Minä en tarvitse tätä."</span></li>
        <li>对比：<span class="speakable-finnish">"Minä haluan tätä, mutta en tarvitse tätä."</span></li>
        <li>实践：<span class="speakable-finnish">"Minä tulen kotiin → Tarvitsen avainta."</span></li>
        <li>感受疲惫时 → 说：<span class="speakable-finnish">"Tarvitsen lepoa."</span></li>
    </ul>
</section>

<hr>

<section id="challenge">
    <h2>🚨 语言出血实验挑战（三日生存计划）</h2>
    <h3>📆 第1日：</h3>
    <ul>
        <li>在售票机前说：<span class="speakable-finnish">"Tarvitsen lippua."</span></li>
        <li>指着屏幕问：<span class="speakable-finnish">"Tässä ok?"</span></li>
        <li>在公共场合感觉吵闹 → 对自己说：<span class="speakable-finnish">"Tarvitsen hiljaisuutta."</span></li>
    </ul>
    <h3>📆 第2日：</h3>
    <ul>
        <li>在邮局说：<span class="speakable-finnish">"Tarvitsen lomaketta."</span></li>
        <li>拿起表格问：<span class="speakable-finnish">"Tässä on kaikki?"</span></li>
        <li>感觉不适时 → 思考：<span class="speakable-finnish">"Tarvitsen lääkettä?"</span></li>
    </ul>
    <h3>📆 第3日：</h3>
    <ul>
        <li>在家找钥匙：<span class="speakable-finnish">"En löydä avainta..."</span></li>
        <li>对室友/房东说：<span class="speakable-finnish">"Tarvitsen avainta."</span></li>
        <li>遇到一个复杂的问题 → 说：<span class="speakable-finnish">"Tarvitsen tietoa."</span></li>
    </ul>
</section>

<hr>

<section id="practice-list">
    <h2>✅ 高频日常用品语块练习清单</h2>
    <p>每天选其中3句，在不同场景中实践：</p>
    <ul>
        <li><span class="speakable-finnish">Tarvitsen lippua.</span></li>
        <li><span class="speakable-finnish">Tarvitsen avainta.</span></li>
        <li><span class="speakable-finnish">Tarvitsen laukkua.</span></li>
        <li><span class="speakable-finnish">Tarvitsen lomaketta.</span></li>
        <li><span class="speakable-finnish">Tarvitsen tietoa.</span></li>
        <li><span class="speakable-finnish">Tarvitsen kirjettä.</span></li>
        <li><span class="speakable-finnish">Tarvitsen paperia.</span></li>
        <li><span class="speakable-finnish">Tarvitsen jotain.</span></li>
        <li><span class="speakable-finnish">Tarvitsen apua.</span></li>
        <li><span class="speakable-finnish">Tarvitsen aikaa.</span></li>
        <li><span class="speakable-finnish">Tarvitsen laturia.</span></li>
        <li><span class="speakable-finnish">Tarvitsen lääkettä.</span></li>
        <li><span class="speakable-finnish">Tarvitsen rahaa.</span></li>
        <li><span class="speakable-finnish">Tarvitsen hiljaisuutta.</span></li>
        <li><span class="speakable-finnish">Tarvitsen lepoa.</span></li>
    </ul>
</section>

<hr>

<section id="cognitive-implantation">
    <h2>🧠 认知植入手术（今日任务）</h2>
    <p>你的任务不是掌握语法，而是<strong>激活“我得用”的语言紧迫感</strong>。</p>
    <h3>🧠 语言出血任务：</h3>
    <ol>
        <li>在超市拿起一个包 → 说：<span class="speakable-finnish">"Tämä laukku ok? Tarvitsen laukkua."</span></li>
        <li>在车站对机器说：<span class="speakable-finnish">"Tarvitsen lippua. Ostaessa... miten tässä?"</span></li>
        <li>手机没电时 → 说：<span class="speakable-finnish">"Tarvitsen laturia."</span></li>
    </ol>
</section>

<hr>

<footer>
    <p>版权归芬兰语教学设计团队所有 | 如需继续构建下一阶段内容，请联系作者。</p>
</footer>

<script>
/**
 * 调试输出函数
 * @param {string} message - 要显示的消息
 */
function debugLog(message) {
    const output = document.getElementById('debug-output');
    if (output) {
        const time = new Date().toLocaleTimeString();
        output.innerHTML += `[${time}] ${message}<br>`;
        output.scrollTop = output.scrollHeight;
    }
    console.log(message);
}

/**
 * 测试基本TTS功能
 */
function testBasicTTS() {
    debugLog('开始测试基本TTS功能...');
    if (!('speechSynthesis' in window)) {
        debugLog('❌ 错误：浏览器不支持语音合成API');
        alert('您的浏览器不支持语音合成功能，请尝试使用Chrome、Edge或Firefox的最新版本。');
        return;
    }
    debugLog('✅ 浏览器支持语音合成API');
    
    const utterance = new SpeechSynthesisUtterance('Hello World');
    utterance.onstart = () => debugLog('✅ 英语测试开始播放');
    utterance.onend = () => debugLog('✅ 英语测试播放完成');
    utterance.onerror = (event) => debugLog('❌ 英语测试错误: ' + event.error);
    
    window.speechSynthesis.speak(utterance);
}

/**
 * 测试芬兰语TTS功能
 */
function testFinnishTTS() {
    debugLog('开始测试芬兰语TTS功能...');
    const utterance = new SpeechSynthesisUtterance('Tarvitsen lippua');
    utterance.lang = 'fi-FI';
    utterance.onstart = () => debugLog('✅ 芬兰语测试开始播放');
    utterance.onend = () => debugLog('✅ 芬兰语测试播放完成');
    utterance.onerror = (event) => debugLog('❌ 芬兰语测试错误: ' + event.error);
    
    window.speechSynthesis.speak(utterance);
}

/**
 * 列出所有可用语音
 */
function listVoices() {
    debugLog('正在获取可用语音列表...');
    const voices = window.speechSynthesis.getVoices();
    
    if (voices.length === 0) {
        debugLog('⚠️ 未找到任何语音，语音可能还在加载中');
        return;
    }
    
    debugLog(`找到 ${voices.length} 个可用语音:`);
    voices.forEach((voice, index) => {
        const isDefault = voice.default ? ' (默认)' : '';
        debugLog(`${index + 1}. ${voice.name} (${voice.lang})${isDefault}`);
    });
    
    // 查找芬兰语语音
    const finnishVoices = voices.filter(voice => 
        voice.lang.toLowerCase().startsWith('fi') || 
        voice.name.toLowerCase().includes('finnish') ||
        voice.name.toLowerCase().includes('suomi')
    );
    
    if (finnishVoices.length > 0) {
        debugLog(`✅ 找到 ${finnishVoices.length} 个芬兰语语音:`);
        finnishVoices.forEach(voice => {
            debugLog(`  - ${voice.name} (${voice.lang})`);
        });
    } else {
        debugLog('❌ 未找到芬兰语语音');
    }
}

/**
 * 移除调试区域
 */
function removeDebugSection() {
    const debugSection = document.querySelector('.debug-section');
    if (debugSection) {
        debugSection.style.display = 'none';
        debugLog('调试区域已隐藏');
    }
}

// 全局变量跟踪播放状态
let isSpeaking = false;

/**
 * 核心语音合成函数
 * @param {string} text - 要播放的文本
 * @param {string} lang - 语言代码 (例如 'fi-FI')
 */
function speakText(text, lang) {
    debugLog(`尝试播放: "${text}" (语言: ${lang})`);
    
    if (!('speechSynthesis' in window)) {
        alert('抱歉，您的浏览器不支持语音合成。');
        debugLog('❌ 语音合成API不可用');
        return;
    }
    
    // 如果正在播放，先停止
    if (isSpeaking) {
        window.speechSynthesis.cancel();
        debugLog('⏹️ 停止之前的播放');
        // 等待一小段时间确保停止完成
        setTimeout(() => {
            startSpeaking(text, lang);
        }, 100);
    } else {
        startSpeaking(text, lang);
    }
}

/**
 * 开始语音播放的内部函数
 * @param {string} text - 要播放的文本
 * @param {string} lang - 语言代码
 */
function startSpeaking(text, lang) {
    isSpeaking = true;
    
    const utterance = new SpeechSynthesisUtterance(text);
    utterance.lang = lang;
    utterance.rate = 0.85; // 稍慢语速
    utterance.volume = 1.0;
    utterance.pitch = 1.0;

    // 尝试获取并设置特定语言的语音
    const voices = window.speechSynthesis.getVoices();
    let selectedVoice = null;
    if (lang.startsWith('fi')) {
        selectedVoice = voices.find(voice => 
            voice.lang.toLowerCase().startsWith('fi') || 
            voice.name.toLowerCase().includes('finnish') ||
            voice.name.toLowerCase().includes('suomi')
        );
    }
    
    if (selectedVoice) {
        utterance.voice = selectedVoice;
        debugLog(`使用语音: ${selectedVoice.name} (${selectedVoice.lang})`);
    } else {
        debugLog(`⚠️ 未找到语言 ${lang} 的特定语音，使用默认语音`);
    }
    
    utterance.onstart = () => {
        debugLog(`✅ 开始播放: "${text}"`);
    };
    
    utterance.onend = () => {
        debugLog(`✅ 播放完成: "${text}"`);
        isSpeaking = false;
    };
    
    utterance.onerror = (event) => {
        debugLog(`❌ 播放错误: ${event.error} (文本: "${text}")`);
        isSpeaking = false;
        // 只在不是interrupted错误时显示alert
        if (event.error !== 'interrupted') {
            alert('语音播放出错: ' + event.error);
        }
    };

    window.speechSynthesis.speak(utterance);
}

/**
 * 为HTML元素添加TTS播放按钮
 * @param {HTMLElement} element - 要附加按钮的HTML元素
 * @param {string} textToSpeak - 点击按钮时要朗读的文本
 * @param {string} lang - 文本的语言代码
 */
function addTTSButton(element, textToSpeak, lang) {
    if (!textToSpeak || textToSpeak.trim() === '') {
        debugLog(`⚠️ 跳过空文本元素: ${element.tagName}`);
        return; // 如果没有文本则不添加按钮
    }
    
    // 检查是否已经有按钮了
    if (element.querySelector('.tts-button')) {
        debugLog(`⚠️ 元素已有TTS按钮: "${textToSpeak.trim()}"`);
        return;
    }
    
    const button = document.createElement('button');
    button.className = 'tts-button';
    button.innerHTML = '🔊'; //喇叭图标
    button.title = '播放: ' + textToSpeak.trim();
    button.setAttribute('aria-label', '播放音频: ' + textToSpeak.trim());
    
    button.onclick = function(event) {
        event.preventDefault(); // 防止默认行为
        event.stopPropagation(); // 防止触发父元素的点击事件
        
        // 防止在播放期间重复点击
        if (isSpeaking) {
            debugLog(`⚠️ 播放中，忽略重复点击: "${textToSpeak.trim()}"`);
            return false;
        }
        
        debugLog(`🔊 按钮被点击: "${textToSpeak.trim()}" (语言: ${lang})`);
        
        // 添加视觉反馈
        const originalText = button.innerHTML;
        button.innerHTML = '🔇'; // 改为静音图标表示正在播放
        button.disabled = true;
        
        // 播放完成后恢复按钮
        const checkCompletion = () => {
            if (!isSpeaking) {
                button.innerHTML = originalText;
                button.disabled = false;
            } else {
                setTimeout(checkCompletion, 100);
            }
        };
        
        speakText(textToSpeak.trim(), lang);
        setTimeout(checkCompletion, 100);
        
        return false; // 确保不会触发其他事件
    };
    
    element.appendChild(button);
    debugLog(`✅ 已添加TTS按钮: "${textToSpeak.trim()}" (语言: ${lang})`);
}

/**
 * 初始化TTS按钮，在文档加载完成后执行。
 * 确保在语音列表加载后再添加按钮，以正确选择语音。
 */
function initializeTTSFunctionality() {
    debugLog('🚀 开始初始化TTS功能...');
    const finnishLang = 'fi-FI';

    // 等待一下确保DOM完全加载
    setTimeout(() => {
        debugLog('📝 开始添加TTS按钮到各个部分...');

        // 认知绑定核心表
        document.querySelectorAll('#cognitive-core table tbody tr').forEach((row) => {
            const fiTextCell = row.cells[2]; // 芬兰语结构列
            if (fiTextCell) {
                addTTSButton(fiTextCell, fiTextCell.textContent, finnishLang);
            }
        });

        // 高频日常用品词汇表
        document.querySelectorAll('#vocab-table table tbody tr').forEach((row) => {
            const originalCell = row.cells[0]; // 原形
            if (originalCell) addTTSButton(originalCell, originalCell.textContent, finnishLang);
            const partitiveCell = row.cells[1]; // 部分格
            if (partitiveCell) addTTSButton(partitiveCell, partitiveCell.textContent, finnishLang);
            const exampleCell = row.cells[3]; // 示例句子
            if (exampleCell) addTTSButton(exampleCell, exampleCell.textContent, finnishLang);
        });

        // 核心语块模板
        document.querySelectorAll('#core-blocks table tbody tr').forEach((row) => {
            const chunkCell = row.cells[0]; // 语块
            if (chunkCell) addTTSButton(chunkCell, chunkCell.textContent, finnishLang);
        });

        // 场景训练套件
        document.querySelectorAll('#scenario-training .example p').forEach((p) => {
            const speakableSpan = p.querySelector('.speakable-finnish');
            if (speakableSpan) {
                addTTSButton(speakableSpan, speakableSpan.textContent, finnishLang);
            } else { // Fallback for raw text without span, but check if it's Finnish
                const text = p.textContent.trim();
                // Check if it looks like a Finnish sentence (starts with capital, contains common Finnish words)
                if (text.match(/^[A-ZÅÄÖ].*\.$/) || text.includes('Tarvitsen') || text.includes('Missä') || text.includes('En löydä') || text.includes('Tässä')) {
                    addTTSButton(p, text, finnishLang);
                }
            }
        });


        // 肢体绑定训练
        document.querySelectorAll('#body-binding table tbody tr').forEach((row) => {
            const langCell = row.cells[1]; // 配套语言
            if (langCell) addTTSButton(langCell, langCell.textContent, finnishLang);
        });

        // 结构变形训练
        document.querySelectorAll('#structure-deformation table tbody tr').forEach((row) => {
            const chunkCell = row.cells[1]; // 语块
            if (chunkCell) addTTSButton(chunkCell, chunkCell.textContent, finnishLang);
        });

        // 每日语言出血训练 (ul/li)
        document.querySelectorAll('#daily-bleeding-training ul li').forEach((li) => {
            const speakableSpan = li.querySelector('.speakable-finnish');
            if (speakableSpan) {
                addTTSButton(speakableSpan, speakableSpan.textContent, finnishLang);
            }
        });

        // 语言出血实验挑战 (ul/li)
        document.querySelectorAll('#challenge ul li').forEach((li) => {
            const speakableSpan = li.querySelector('.speakable-finnish');
            if (speakableSpan) {
                addTTSButton(speakableSpan, speakableSpan.textContent, finnishLang);
            }
        });

        // 高频日常用品语块练习清单 (ul/li)
        document.querySelectorAll('#practice-list ul li').forEach((li) => {
            const speakableSpan = li.querySelector('.speakable-finnish');
            if (speakableSpan) {
                addTTSButton(speakableSpan, speakableSpan.textContent, finnishLang);
            }
        });

        // 认知植入手术 (ol/li)
        document.querySelectorAll('#cognitive-implantation ol li').forEach((li) => {
            const speakableSpan = li.querySelector('.speakable-finnish');
            if (speakableSpan) {
                addTTSButton(speakableSpan, speakableSpan.textContent, finnishLang);
            }
        });


        debugLog('✅ TTS功能初始化完毕！');
        
    }, 500); // 延迟500毫秒确保DOM完全加载

}

document.addEventListener('DOMContentLoaded', () => {
    if (window.speechSynthesis.getVoices().length === 0) {
        window.speechSynthesis.onvoiceschanged = initializeTTSFunctionality;
    } else {
        initializeTTSFunctionality();
    }
});

</script>

</body>
</html>